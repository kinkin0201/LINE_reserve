<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <title>パーソナルジム予約</title>
  <style>
    /* スタイル定義 */
    body { 
      padding: 60px; 
      font-family: 'Hiragino Kaku Gothic ProN', 'メイリオ', sans-serif;
      font-size: 28px;
      line-height: 1.6;
    }
    
    .form-container { 
      max-width: 100%; 
      margin: 0 auto; 
      padding: 0;
      background-color: #fff;
    }
    
    /* 予約カレンダーのテーブル固定ヘッダー・列のためのCSS */
    .calendar-container { 
      position: relative;
      margin-bottom: 20px; 
      max-height: 1280px; /* 最大高さを設定 */
      overflow: auto;
      border: 1px solid #dee2e6;
    }
    
    /* テーブル全体の設定 */
    .calendar-container table {
      width: auto; /* 内容に合わせて幅を決定 */
      border-collapse: separate; /* セルの境界を分離モードに */
      border-spacing: 0;
      table-layout: fixed; /* 列幅を固定 */
    }

    /* テーブルヘッダー（曜日行）を固定 */
    .calendar-container thead {
      position: sticky;
      top: 0;
      z-index: 2; /* 他の要素より前面に */
      background-color: #f8f9fa;
    }

    /* 時間列（左端の列）を固定 */
    .calendar-container .time-header {
      position: sticky;
      left: 0;
      z-index: 1; /* ヘッダーよりは後ろ、他のセルよりは前に */
      background-color: #f8f9fa;
    }

    /* 左上のセル（時間と曜日の交差部分）を両方固定 */
    .calendar-container thead .time-header {
      position: sticky;
      top: 0;
      left: 0;
      z-index: 3; /* 最前面に */
      background-color: #f8f9fa;
    }

    /* セルのサイズを調整 */
    .calendar-container th, 
    .calendar-container td {
      min-width: 100px; /* セルの最小幅 */
      height: 60px; /* セルの高さ */
    }

    /* 時間列の幅を調整 */
    .calendar-container .time-header {
      min-width: 120px; /* 時間列は少し広めに */
    }

    /* ボックスシャドウで固定部分の境界を強調 */
    .calendar-container thead th {
      box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
    }
    .calendar-container .time-header {
      box-shadow: 2px 0 2px -1px rgba(0,0,0,0.1);
    }
    .calendar-container thead .time-header {
      box-shadow: 2px 2px 2px -1px rgba(0,0,0,0.1);
    }
    
    /* 画像ヘッダー */
    .header-image-container {
      width: 100%;
      margin-bottom: 0; /* 下部のマージンを削除 */
      text-align: center;
    }

    .header-image {
      max-width: 100%;
      height: auto;
      margin-bottom: 60px;
    }
    
    /* タブナビゲーションの調整 */
    .nav-tabs {
      padding: 0px; /* 左右にパディングを追加 */
    }

    .nav-tabs .nav-link {
      font-size: 32px; /* タブ文字サイズ拡大 */
      padding: 16px 24px; /* パディングを増やす */
      color: #6c757d; /* 非アクティブタブは灰色 */
      font-weight: normal; /* 非アクティブタブは標準の太さ */
      border: 1px solid #dee2e6; /* 枠線を追加 */
      border-bottom: none; /* 下部の枠線を削除 */
      margin-right: 8px; /* タブ間の余白 */
      border-radius: 8px 8px 0 0; /* 上部の角を丸く */
      transition: all 0.3s ease; /* アニメーション効果 */
    }

    .nav-tabs .nav-link:hover {
      background-color: rgba(13, 110, 253, 0.1); /* ホバー時の背景色 */
      color: #0d6efd; /* ホバー時のテキスト色 */
    }

    .nav-tabs .nav-link.active {
      color: #fff; /* アクティブタブは白色 */
      background-color: #0d6efd; /* アクティブタブの背景色 */
      font-weight: bold; /* アクティブタブは太字 */
      border: 3px solid #0d6efd; 
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1); /* 影を追加 */
    }

    /* タブコンテンツエリア */
    .tab-content {
      border: 3px solid #0d6efd; /* 細めの枠線 */
      padding: 30px;
      background-color: #fff;
    }
    
    /* フォーム要素の調整 */
    .form-label {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .form-select,
    .form-control {
      font-size: 28px;
      padding: 12px;
      height: auto;
    }
    
    /* 時間枠のスタイル調整 */
    .time-slot {
      cursor: pointer; 
      padding: 10px; 
      border-radius: 6px; 
      text-align: center;
      transition: background-color 0.2s; 
      border: 1px solid #ddd; 
      margin: 2px;
      min-width: 92px;
      font-size: 32px;
    }
    
    .time-slot:hover { 
      background-color: #e9ecef; 
    }
    

    /* 選択された時間枠のスタイル - シンプル版 */
    .time-slot.selected { 
      background-color: #0d6efd;
      color: white; 
      border-color: #0d6efd;
      font-weight: bold;
      box-shadow: 0 0px 5px rgba(13, 110, 253, 0.5);
    }

    /* 選択可能スロットのホバー効果 */
    .time-slot.available:hover { 
      background-color: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    .time-slot.available { 
      background-color: #e2f0ff; 
      color: #0a58ca; 
      border-color: #b6d4fe; 
    }
    
    .time-slot.unavailable {
      background-color: #f8f9fa;
      color: #adb5bd;
      cursor: not-allowed;
      border-color: #e9ecef;
      font-weight: bold; /* 記号を強調 */
      opacity: 0.7; /* 透明度で区別 */
    }
    
    .time-header { 
      text-align: center; 
      font-weight: bold; 
      padding: 12px; 
      vertical-align: middle;
      width: 80px; 
      font-size: 32px;
    }
    
    .day-header { 
      text-align: center; 
      font-weight: bold; 
      padding: 12px; 
      background-color: #f8f9fa; 
      font-size: 32px;
    }
    
    .holiday-cell { 
      background-color: #f8d7da; 
      text-align: center; 
      vertical-align: middle; 
    }
    
    .today { 
      background-color: #fff3cd; 
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    th, td { 
      padding: 8px; 
      text-align: center; 
      border: 1px solid #dee2e6; 
      font-size: 28px;
    }
    
    .nav-link { 
      cursor: pointer; 
    }
    
    .reservations-list { 
      margin-top: 20px; 
    }
    
    #loadingIndicator { 
      text-align: center; 
      padding: 20px; 
      font-size: 28px;
    }
    
    #result { 
      margin-top: 20px; 
    }
    
    /* 土日の色付け */
    .day-header.sunday { 
      color: #dc3545; 
    }
    
    .day-header.saturday { 
      color: #0d6efd; 
    }
    
    .holiday-text { 
      font-size: 28px; 
      color: #6c757d; 
    }
    
    /* 週ナビゲーションボタンのスタイル調整 */
    #prevWeek, #nextWeek, #todayBtn {
      padding: 10px 16px;
      font-size: 28px;
    }
    
    /* 本日ボタンのスタイル特別調整 */
    #todayBtn {
      background-color: #0d6efd;
      border-color: #0d6efd;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    #todayBtn:hover:not(:disabled) {
      background-color: #0d47a1;
      border-color: #0d47a1;
    }
    
    #todayBtn:disabled {
      opacity: 0.6;
    }
    
    /* 選択されている日時の表示スタイル */
    #selectedDateTime {
      font-size: 48px;
      font-weight: bold;
      padding: 12px;
    }
    
    /* 予約リスト内のアイテムを見やすく調整 */
    .list-group-item {
      padding: 16px;
    }
    
    .list-group-item h5 {
      font-size: 32px;
    }
    
    .list-group-item p {
      font-size: 28px;
    }
    
    .cancel-btn {
      padding: 8px 16px;
      font-size: 28px;
    }
    
    /* セクション間のスペーシング調整 */
    .tab-pane {
      padding-top: 16px;
    }
    
    /* アラートメッセージスタイル調整 */
    .alert {
      font-size: 28px;
      padding: 12px;
    }
    
    /* 見出しの調整 */
    h4 {
      font-size: 40px;
      font-weight: bold;
    }
    
    /* フォーム内のプレーンテキスト調整 */
    .form-control-plaintext {
      font-size: 36px;
    }
    
    /* 強調表示するテキスト */
    .emphasis {
      font-size: 40px;
      font-weight: bold;
    }

    hr.my-4 {
      margin-top: 40px !important;
      margin-bottom: 40px !important;
    }

    h4:has(span.text-danger) {
      margin-top: 40px;
      margin-bottom: 24px;
    }
    
    /* 現在の週表示 */
    #currentWeek {
      font-size: 32px;
      font-weight: bold;
      padding: 0 20px;
    }
    
    /* スピナー調整 */
    .spinner-border {
      width: 2rem;
      height: 2rem;
    }

    /* 予約確認・キャンセル画面の追加スタイル */
    .reservation-card {
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .reservation-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .reservation-card .card-header {
      font-size: 32px;
      padding: 12px 16px;
      font-weight: bold;
    }

    .reservation-card .card-title {
      font-size: 36px;
      margin-bottom: 16px;
      font-weight: bold;
    }

    /* カード内の強調テキスト */
    .reservation-card .card-text strong {
      font-weight: bold;
    }

    .reservation-card .card-text {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .reservation-card .cancel-btn {
      font-size: 28px;
      padding: 10px 20px;
      border-radius: 10px;
    }

    /* アイコンサイズ調整 */
    .reservation-card .bi {
      font-size: 110%;
      vertical-align: middle;
    }

    .reservation-card .bg-warning.text-dark {
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 24px;
    }

    /* 予約ID表示 */
    .reservation-card .card-header small {
      font-size: 20px;
      font-weight: bold;
    }

    /* キャンセル確認モーダル */
    #cancelConfirmModal .modal-dialog {
      max-width: 90%;
      margin: 1.75rem auto;
    }

    #cancelConfirmModal .modal-content {
      border-radius: 12px;
      overflow: hidden;
    }

    #cancelConfirmModal .modal-header {
      padding: 24px;
    }
    
    #cancelConfirmModal .modal-title {
      font-size: 32px;
      font-weight: bold;
    }

    #cancelConfirmModal .modal-body {
      font-size: 36px;
      padding: 24px;
    }

    #cancelConfirmModal .modal-footer .btn {
      font-size: 32px;
      padding: 12px 24px;
      border-radius: 8px;
    }

    #reservationCompleteModal .modal-dialog {
      max-width: 90%;
      margin: 1.75rem auto;
    }

    #reservationCompleteModal .modal-header .modal-title {
      font-size: 40px;
      font-weight: bold;
    }

    #reservationCompleteModal .modal-body {
      font-size: 40px; /* フォントサイズを1.5倍に */
    }

    #reservationCompleteModal .modal-body h4 {
      font-size: 40px; 
    }

    #reservationCompleteModal .modal-body p {
      font-size: 36px; /* 基本サイズに対して相対的に調整 */
    }

    #reservationCompleteModal .modal-body .alert {
    font-size: 24px; /* アラート内のフォントサイズを少し小さめに調整 */
    }

    /* 予約確定ボタンをより魅力的に */
    #submitBtn {
      background-color: #00B900;
      color: white;
      padding: 20px;
      font-size: 40px;
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: none;
    }

    #submitBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      background-color: #00a000;
    }

    #submitBtn:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #submitBtn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
    }

    /* 選択された日時をより強調表示 */
    #selectedDateTime.alert-info {
      background-color: #e3f2fd;
      border-color: #90caf9;
      color: #0d47a1;
      font-size: 40px;
      font-weight: bold;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border-left: 8px solid #1976d2;
    }

    /* 予約確定モーダルスタイル */
    #confirmationModal .modal-dialog {
      max-width: 80%;
      margin: 1.75rem auto;
    }

    #confirmationModal .modal-content {
      border-radius: 15px;
      overflow: hidden;
    }

    #confirmationModal .modal-header {
      background-color: #00B900;
      color: white;
      padding: 16px 20px;
      font-size: 36px;
      font-weight: bold;
    }

    /* 予約確定モーダルのタイトルスタイル */
    #confirmationModal .modal-title {
      font-size: 40px;
      font-weight: bold;
    }

    #confirmationModal .modal-body {
      padding: 20px;
      font-size: 36px;
    }

    #confirmationModal .modal-footer {
      padding: 16px 20px;
    }

    #confirmationModal .btn-secondary {
      font-size: 40px;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
    }

    #confirmationModal .btn-success {
      background-color: #00B900;
      font-size: 40px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container form-container">
    <!-- ヘッダーを画像にする（必要に応じて画像URLを変更） -->
    <div class="header-image-container">
      <img src="https://app.veryda.jp/veryda_imegs/%E4%BA%88%E7%B4%84%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0.png" alt="予約フォーム" class="header-image">
    </div>

    <ul class="nav nav-tabs mb-0" id="reservationTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link <?= activeTab === 'new' ? 'active' : '' ?>" id="new-tab" data-bs-toggle="tab" data-bs-target="#new" type="button" role="tab" aria-controls="new" aria-selected="<?= activeTab === 'new' ? 'true' : 'false' ?>">
          <i class="bi bi-calendar-plus me-2"></i>新規予約
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <?= activeTab === 'list' ? 'active' : '' ?>" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="<?= activeTab === 'list' ? 'true' : 'false' ?>">
          <i class="bi bi-calendar-check me-2"></i>予約確認・キャンセル
        </button>
      </li>
    </ul>

    <div class="tab-content" id="reservationTabContent">

      <!-- 新規予約タブ -->
      <div class="tab-pane fade <?= activeTab === 'new' ? 'show active' : '' ?>" id="new" role="tabpanel" aria-labelledby="new-tab">
        <h4>新規予約</h4>
        <form id="reservationForm">
          <input type="hidden" id="userId" name="userId" value="<?= userId ?>">

          <div class="row mb-3">
            <div class="col-12" style="font-size: 40px;">
              <div class="d-flex align-items-center">
                <span class="form-control-plaintext mb-0 p-0"><b><?= userName ?> 様</b></span>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">【パーソナルトレーニング】</h5>
              <p class="card-text">トレーナーがマンツーマンでサポートします。<br>所要時間：60分</p>
            </div>
          </div>

          <hr class="my-4">

          <h4>予約日時の選択 <span class="text-danger">*</span></h4>


          <!-- 週ナビゲーション部分を修正して「本日」ボタンを追加 -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button type="button" class="btn btn-outline-secondary" id="prevWeek" disabled>
              <i class="bi bi-chevron-left"></i> 前の週
             </button>
           <div class="d-flex align-items-center">
            <button type="button" class="btn btn-primary mx-2" id="todayBtn">
              <i class="bi bi-calendar-event"></i> 本日
            </button>
           <div id="currentWeek" class="text-center fw-bold"></div>
          </div>
            <button type="button" class="btn btn-outline-secondary" id="nextWeek" disabled>
            次の週 <i class="bi bi-chevron-right"></i>
            </button>
          </div>

          <div class="calendar-container">
            <table class="table table-bordered">
              <thead id="calendarHeader">
                <tr id="daysRow">
                  <th class="time-header">時間</th>
                </tr>
              </thead>
              <tbody id="calendarBody">
                <tr>
                  <td colspan="8" class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>予約可能な時間枠を読み込み中...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mb-3">
            <label class="form-label">選択されている日時:</label>
            <div id="selectedDateTime" class="alert alert-secondary">日時を選択してください</div>
            <input type="hidden" id="selectedDate" name="date">
            <input type="hidden" id="selectedTime" name="time">
          </div>

          <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>
            <i class="bi bi-calendar-check me-2"></i>予約を確定する
          </button>
        </form>
        <div id="result" class="mt-3"></div>
      </div>

      <!-- 予約確認・キャンセルタブ -->
      <div class="tab-pane fade <?= activeTab === 'list' ? 'show active' : '' ?>" id="list" role="tabpanel" aria-labelledby="list-tab">
        <h4>予約確認・キャンセル</h4>
        <div id="reservationsList" class="reservations-list">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>予約情報を読み込み中...</p>
          </div>
        </div>
         <div id="cancelResult" class="mt-3"></div>
      </div>

    </div>
  </div>
  
  <!-- 予約確認モーダル -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="confirmationModalLabel">
            <i class="bi bi-calendar-check me-2"></i>予約内容の確認
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div><strong>日付：</strong><span id="confirmDate"></span></div>
          </div>
          <div class="mb-3">
            <div><strong>時間：</strong><span id="confirmTime"></span></div>
          </div>
          <div class="mb-3">
            <div><strong>内容：</strong>パーソナルトレーニング</div>
          </div>
          
          <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle me-2"></i>
            この内容で予約を確定します。よろしいですか？
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-arrow-left me-2"></i>戻る
          </button>
          <button type="button" class="btn btn-success" id="modalConfirmBtn">
            <i class="bi bi-check-circle me-2"></i>予約を確定する
          </button>
        </div>
      </div>
    </div>
  </div>

<!-- キャンセル確認モーダル（改善版）-->
<div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="cancelConfirmModalLabel">
          <i class="bi bi-calendar-x me-2"></i>予約キャンセルの確認
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>以下の予約をキャンセルします。この操作は取り消せません。</p>
        
        <div class="alert alert-light">
          <div class="mb-3">
            <div><strong>予約ID：</strong><span id="modalReservationId"></span></div>
          </div>
          <div class="mb-3">
            <div><strong>日付：</strong><span id="modalReservationDate"></span></div>
          </div>
          <div class="mb-3">
            <div><strong>時間：</strong><span id="modalReservationTime"></span></div>
          </div>
          <div class="mb-3">
            <div><strong>内容：</strong><span id="modalReservationContent">パーソナルトレーニング</span></div>
          </div>
        </div>
        
        <div class="alert alert-danger mt-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          本当にキャンセルしますか？
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left me-2"></i>戻る
        </button>
        <button type="button" class="btn btn-danger" id="confirmCancelBtn">
          <i class="bi bi-x-circle me-2"></i>
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          キャンセルする
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 予約完了モーダル - 操作不能バージョン -->
<div class="modal fade" id="reservationCompleteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="reservationCompleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="reservationCompleteModalLabel">
          <i class="bi bi-check-circle-fill me-2"></i>予約完了
        </h5>
        <!-- 閉じるボタンなし -->
      </div>
      <div class="modal-body text-center">
        <div class="py-3">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 64px;"></i>
        </div>
        <h4 class="mb-3">予約が完了しました</h4>
        <p class="mb-3">ご予約ありがとうございます。</p>
        <!--
        <p class="mb-3">ご予約内容はLINEにメッセージでお送りしました。
        </p>-->
        <div id="completeReservationDetails" class="alert alert-light text-start mb-4">
          <p><strong>日時：</strong><span id="completeDate"></span></p>
          <p><strong>内容：</strong>パーソナルトレーニング</p>
        </div>
        <p class="text-muted mt-4">LINEアプリに戻るには画面を閉じてください</p>
      </div>
      <!-- フッターなし -->
    </div>
  </div>
</div>

<!-- 操作防止用オーバーレイ -->
<div id="interactionBlocker" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9998; background:transparent;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

// --- クライアントサイドJavaScript ---
// ユーザーIDをグローバル変数として設定
const userId = document.getElementById('userId').value; // 最初の行で確実にユーザーIDを取得
let currentWeekStart = null; // 表示中の週の開始日(Dateオブジェクト)

// GASから渡されるテンプレート変数を使って初期化
const startDate = new Date('<?= startDate ?>'); // 予約可能開始日
const endDate = new Date('<?= endDate ?>');     // 予約可能終了日

// GASから渡される設定
const businessHours = JSON.parse('<?= businessHoursJson ?>');
const closedDays = JSON.parse('<?= closedDaysJson ?>');
const sessionDuration = <?= sessionDuration ?>;
const minDaysAhead = <?= minDaysAhead ?>;
const daysAhead = <?= daysAhead ?>;

/**
 * DOM読み込み完了時の初期化処理
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('ページ初期化開始');
  try {
    // 週の開始日を本日に設定
    const today = new Date();
    currentWeekStart = new Date(today);
    console.log('週の開始日セット:', formatDate(currentWeekStart));
    
    setupEventListeners(); // イベントリスナーを設定
    updateWeekNavigation(); // 週ナビゲーションの状態を更新
    updateCalendar(); // カレンダーを更新
    
  } catch (error) {
    console.error('初期化中にエラーが発生しました:', error);
    alert('ページの初期化中にエラーが発生しました: ' + error.message);
  }
});

/**
 * イベントリスナーを設定する
 */
function setupEventListeners() {
  // タブ切り替え時に予約一覧を読み込む
  document.getElementById('list-tab').addEventListener('click', loadReservations);

  // 週移動ボタンのクリックイベント
  document.getElementById('prevWeek').addEventListener('click', () => navigateWeek(-7));
  document.getElementById('nextWeek').addEventListener('click', () => navigateWeek(7));
  
  // 本日ボタンのクリックイベント
  document.getElementById('todayBtn').addEventListener('click', goToToday);

  // 予約フォームの送信イベント
  document.getElementById('reservationForm').addEventListener('submit', handleFormSubmit);
}

/**
 * 本日の週に移動する
 */
function goToToday() {
  const today = new Date();
  // 今日の日付から開始する週を設定
  currentWeekStart = new Date(today);
  updateCalendar(); // カレンダーを更新
}

/**
 * 表示する週を移動する
 * @param {number} days - 移動する日数 (-7で前の週, 7で次の週)
 */
function navigateWeek(days) {
  // ボタンの状態を「読み込み中」に変更
  const prevWeekBtn = document.getElementById('prevWeek');
  const nextWeekBtn = document.getElementById('nextWeek');
  const todayBtn = document.getElementById('todayBtn');
  
  // すべてのナビゲーションボタンを無効化
  prevWeekBtn.disabled = true;
  nextWeekBtn.disabled = true;
  todayBtn.disabled = true;
  
  // クリックされたボタンを特定
  const clickedBtn = days < 0 ? prevWeekBtn : nextWeekBtn;
  
  // クリックされたボタンに読み込み中表示を追加
  const originalText = clickedBtn.innerHTML;
  clickedBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> `;
  
  const newWeekStart = new Date(currentWeekStart);
  newWeekStart.setDate(newWeekStart.getDate() + days);

  // 前の週への移動制限: 本日より前にはならないようにする
  if (days < 0) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (newWeekStart < today) {
      // ボタンを元に戻して早期リターン
      clickedBtn.innerHTML = originalText;
      updateWeekNavigation();
      return;
    }
  }
  
  // 次の週への移動制限: 予約可能終了日を超えないようにする
  if (days > 0) {
    const newWeekEnd = new Date(newWeekStart);
    newWeekEnd.setDate(newWeekStart.getDate() + 6);
    if (newWeekEnd > endDate) {
      // ボタンを元に戻して早期リターン
      clickedBtn.innerHTML = originalText;
      updateWeekNavigation();
      return;
    }
  }

  currentWeekStart = newWeekStart; // 現在の週を更新
  
  // 少し遅延を入れてUIの反応性を向上
  setTimeout(() => {
    updateCalendar(); // カレンダーを再描画
    // 元のボタンテキストを復元
    clickedBtn.innerHTML = originalText;
  }, 300);
}

/**
 * カレンダー表示を更新する関数
 */
function updateCalendar() {
  showLoading(true); // ローディング表示開始
  updateWeekNavigation(); // 週ナビゲーションボタンの状態を更新

  try {
    // デバッグ情報を表示
    console.log("予約可能時間を取得中:", {
      weekStart: formatDate(currentWeekStart)
    });
    
    // サーバーサイド(GAS)のgetWeeklyAvailability関数を呼び出す
    google.script.run
      .withSuccessHandler(handleAvailabilitySuccess) // 成功時のコールバック
      .withFailureHandler(function(error) {
        console.error('カレンダーデータ取得エラー:', error);
        handleAvailabilityFailure(error);
      })
      .getWeeklyAvailability(
        formatDate(currentWeekStart)  // 週の開始日
      ); 
  } catch (error) {
    console.error('カレンダー更新処理でエラー:', error);
    handleAvailabilityFailure('クライアント側でのエラー: ' + error.message);
  }
}

/**
 * 空き状況取得成功時のコールバック関数
 * @param {Array<object>} weekData - サーバーから返された週の空き状況データ
 */
function handleAvailabilitySuccess(weekData) {
   console.log('予約状況データ取得成功:', weekData);
   // データ形式の基本的なチェック
   if (!weekData || !Array.isArray(weekData)) {
     console.error('サーバーから受信したデータ形式が無効です:', weekData);
     handleAvailabilityFailure('無効なデータ形式'); // エラー処理へ
     return;
   }
   renderCalendar(weekData); // カレンダーを描画
   showLoading(false); // ローディング表示終了
}

/**
 * 空き状況取得失敗時のコールバック関数
 * @param {Error|string} error - エラーオブジェクトまたはエラーメッセージ
 */
function handleAvailabilityFailure(error) {
  console.error('予約状況データの取得に失敗しました:', error);
  // カレンダー表示部分にエラーメッセージを表示
  document.getElementById('calendarBody').innerHTML =
    `<tr><td colspan="8" class="text-center text-danger">カレンダー情報の取得に失敗しました。時間をおいて再度お試しください。</td></tr>`;
  showLoading(false); // ローディング表示終了
  // フォーム下部にもエラーメッセージを表示
  displayMessage('result', '<i class="bi bi-exclamation-triangle me-2"></i>カレンダー情報の取得に失敗しました。ページを再読み込みするか、時間をおいて再度お試しください。', 'danger');
}

/**
 * 受け取ったデータをもとにカレンダーを描画する
 * @param {Array<object>} weekData - 週の空き状況データ
 */
function renderCalendar(weekData) {
  updateCalendarHeader(); // ヘッダー（日付と曜日）を更新
  const calendarBody = document.getElementById('calendarBody');
  calendarBody.innerHTML = ''; // 現在のカレンダー内容をクリア

  // 営業時間の定数
  const businessStartHour = businessHours.START;  
  const businessEndHour = businessHours.END;
  const timeInterval = businessHours.TIME_INTERVAL;

  // 利用可能な時間枠があるかどうかのフラグ
  let hasAvailableSlots = false;

  for (let h = businessStartHour; h < businessEndHour; h++) {
    for (let m = 0; m < 60; m += timeInterval) {
      const timeString = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      
      // 各時間帯の行を作成して追加
      const row = createTimeSlotRow(timeString, weekData);
      calendarBody.appendChild(row);

      // 利用可能な時間枠があるかチェック
      const availableSlots = row.querySelectorAll('.time-slot.available');
      if (availableSlots.length > 0) {
        hasAvailableSlots = true;
      }
    }
  }

  // 利用可能な時間枠がない場合はメッセージを表示
  if (!hasAvailableSlots) {
    const noSlotsRow = document.createElement('tr');
    noSlotsRow.innerHTML = `
      <td colspan="8" class="text-center text-warning py-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        現在予約可能な時間枠がありません。別の週をお試しください。
      </td>
    `;
    calendarBody.appendChild(noSlotsRow);
  }
}

/**
 * カレンダーのヘッダー（日付と曜日）を更新する
 */
function updateCalendarHeader() {
  const daysRow = document.getElementById('daysRow');
  daysRow.innerHTML = '<th class="time-header">時間</th>'; // 時間列のヘッダー

  const daysJP = ['日', '月', '火', '水', '木', '金', '土']; // 曜日の日本語表記
  for (let i = 0; i < 7; i++) {
    const date = new Date(currentWeekStart);
    date.setDate(date.getDate() + i); // 表示週の開始日（本日）からi日後の日付
    const dayOfWeek = date.getDay(); // 曜日番号 (0=日, 6=土)
    const isSunday = dayOfWeek === 0;
    const isSaturday = dayOfWeek === 6;
    
    // 今日の日付かどうかを確認
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const currentDate = new Date(date);
    currentDate.setHours(0, 0, 0, 0);
    const isToday = currentDate.getTime() === today.getTime();

    const th = document.createElement('th');
    // 日曜日と土曜日でクラスを付与して色付け、今日の日付にも特別クラスを付与
    th.className = `day-header ${isSunday ? 'sunday' : ''} ${isSaturday ? 'saturday' : ''} ${isToday ? 'today' : ''}`;
    
    // 今日の場合は「今日」という表記を追加
    const todayMark = isToday ? '<span class="badge bg-warning text-dark">今日</span><br>' : '';
    th.innerHTML = `${todayMark}${formatDateMMDD(date)}<br>(${daysJP[dayOfWeek]})`; // MM/DD (曜) 形式で表示
    
    daysRow.appendChild(th);
  }
}

/**
 * 特定の時間帯のカレンダー行（全曜日分）を作成する
 * @param {string} timeString - 時間 (HH:MM形式)
 * @param {Array<object>} weekData - 週の空き状況データ
 * @return {HTMLTableRowElement} - 作成されたテーブル行要素
 */
function createTimeSlotRow(timeString, weekData) {
  const row = document.createElement('tr');

  // 時間セルを作成
  const timeCell = document.createElement('td');
  timeCell.className = 'time-header';
  timeCell.textContent = timeString;
  row.appendChild(timeCell);

  // 各曜日のセルを作成 (7日分)
  for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
    const cell = document.createElement('td');
    const dayData = weekData[dayIndex]; // その曜日のデータ

    if (!dayData) {
       // データが存在しない場合（エラーケース）
       cell.innerHTML = '-';
       cell.classList.add('unavailable'); // 予約不可として表示
    } else if (dayData.isHoliday) {
      // 定休日の場合
      cell.classList.add('holiday-cell'); // 定休日用のスタイル
      cell.innerHTML = '<span class="holiday-text">-</span>'; // シンプルにハイフン表示
    } else {
      // 営業日の場合、時間帯データを検索
      const hourData = dayData.hours ? dayData.hours.find(h => h.time === timeString) : null;
      const slotDiv = document.createElement('div'); // 時間枠表示用のdiv
      slotDiv.classList.add('time-slot'); // 基本スタイル

      // 予約可能かどうかを確認
      if (hourData && hourData.available > 0 && hourData.durationAvailable === true) {
        // 予約可能な場合
        slotDiv.classList.add('available');
        slotDiv.textContent = '◯';
        slotDiv.dataset.date = dayData.date;
        slotDiv.dataset.time = timeString;
        slotDiv.addEventListener('click', () => selectTimeSlot(slotDiv));
        
        // ツールチップを追加
        slotDiv.title = `${timeString}から予約可能です`;
      } else {
        // 予約不可の場合
        slotDiv.classList.add('unavailable');
        slotDiv.textContent = '×';
        
        // ツールチップを追加
        let reason = "この時間枠は予約できません";
        if (hourData) {
          if (hourData.available <= 0) {
            reason = "この時間枠は既に予約が入っています";
          } else if (hourData.durationAvailable === false) {
            reason = `この時間枠は${sessionDuration}分の予約が入りません`;
          }
        }
        slotDiv.title = reason;
      }
      cell.appendChild(slotDiv); // セルに時間枠divを追加
    }
    row.appendChild(cell); // 行にセルを追加
  }
  return row;
}


/**
 * タイムスロットがクリックされたときの処理（シンプル版）
 * @param {HTMLDivElement} element - クリックされた時間枠のdiv要素
 */
function selectTimeSlot(element) {
  // 他の選択済み要素があれば選択解除
  const previouslySelected = document.querySelector('.time-slot.selected');
  if (previouslySelected) {
    previouslySelected.classList.remove('selected');
  }

  // クリックされた要素を選択状態にする
  element.classList.add('selected');

  // 選択されている日時をフォームの隠しフィールドに設定
  const date = element.dataset.date;
  const time = element.dataset.time;
  document.getElementById('selectedDate').value = date;
  document.getElementById('selectedTime').value = time;

  // 終了時刻を計算
  const startDateTime = new Date(date + 'T' + time);
  const endDateTime = new Date(startDateTime.getTime() + sessionDuration * 60000);
  const endTimeStr = `${String(endDateTime.getHours()).padStart(2, '0')}:${String(endDateTime.getMinutes()).padStart(2, '0')}`;

  // 選択されている日時を表示エリアにフォーマットして表示（開始時間～終了時間を表示）
  const displayDate = formatDateWithDayJP(new Date(date + 'T' + time + ':00'));
  document.getElementById('selectedDateTime').textContent = `${displayDate} ${time}～${endTimeStr}`;
  document.getElementById('selectedDateTime').classList.remove('alert-secondary');
  document.getElementById('selectedDateTime').classList.add('alert-info');

  // フォームの入力状態をチェック
  validateForm();
  
  // 予約を確定するボタンまで滑らかにスクロール
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/**
 * フォームの入力状態をチェックし、送信ボタンの有効/無効を切り替える
 */
function validateForm() {
  const submitBtn = document.getElementById('submitBtn');
  const dateSelected = document.getElementById('selectedDate').value !== '';
  const timeSelected = document.getElementById('selectedTime').value !== '';
  
  submitBtn.disabled = !(dateSelected && timeSelected);
}

/**
 * 予約フォーム送信時の処理（モーダル表示版）
 * @param {Event} e - 送信イベント
 */
function handleFormSubmit(e) {
  e.preventDefault(); // フォームの通常の送信動作をキャンセル

  const submitBtn = document.getElementById('submitBtn');
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = ''; // 前回の結果メッセージをクリア

  // --- 入力チェック ---
  if (!document.getElementById('selectedDate').value || !document.getElementById('selectedTime').value) {
    displayMessage('result', '<i class="bi bi-exclamation-triangle me-2"></i>予約日時を選択してください。', 'warning');
    return;
  }
  // --- 入力チェックここまで ---

  const dateValue = document.getElementById('selectedDate').value;
  const timeValue = document.getElementById('selectedTime').value;
  
  // 終了時間を計算して表示
  const startDateTime = new Date(dateValue + 'T' + timeValue);
  const endDateTime = new Date(startDateTime.getTime() + sessionDuration * 60000);
  const endTimeStr = `${String(endDateTime.getHours()).padStart(2, '0')}:${String(endDateTime.getMinutes()).padStart(2, '0')}`;
  
  const displayDate = formatDateWithDayJP(new Date(dateValue + 'T' + timeValue + ':00'));
  
  // モーダルに予約情報を設定
  document.getElementById('confirmDate').textContent = displayDate;
  document.getElementById('confirmTime').textContent = `${timeValue} ～ ${endTimeStr}`;
  
  // モーダルを表示
  const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
  confirmationModal.show();
  
  // モーダルの「予約を確定する」ボタンのイベント登録
  // 既存のイベントリスナーを削除してから追加（二重登録防止）
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  const newModalConfirmBtn = modalConfirmBtn.cloneNode(true);
  modalConfirmBtn.parentNode.replaceChild(newModalConfirmBtn, modalConfirmBtn);
  
  newModalConfirmBtn.addEventListener('click', function() {
    // モーダルを閉じる
    confirmationModal.hide();
    
    // 送信処理開始
    submitReservation({
      userId: userId,
      date: dateValue,
      time: timeValue
    });
  });
}

/**
 * 予約データを送信し、サーバー処理を実行する
 * @param {Object} formData - 送信する予約データ
 */
function submitReservation(formData) {
  const submitBtn = document.getElementById('submitBtn');
  const resultDiv = document.getElementById('result');
  
  // 結果表示エリアをクリア
  resultDiv.innerHTML = '';
  
  // 送信ボタンを無効化し、スピナーを表示
  submitBtn.disabled = true;
  submitBtn.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> 
    処理中...
  `;

  // サーバーサイド(GAS)のcreateReservation関数を呼び出す
  google.script.run
    .withSuccessHandler(result => {
      // ボタンの状態を元に戻す
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-calendar-check me-2"></i>予約を確定する';
      
      // 成功ハンドラに渡す
      handleReservationSuccess(result);
    })
    .withFailureHandler(error => {
      // ボタンの状態を元に戻す
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-calendar-check me-2"></i>予約を確定する';
      
      // 失敗ハンドラに渡す
      handleReservationFailure(error);
    })
    .createReservation(formData); // フォームデータを渡す
}

function handleReservationSuccess(result) {
  console.log('予約結果:', result);

  if (result.success) {
    // フォームの内容をリセット
    resetReservationForm();
    
    // 予約完了モーダルに日時をセットして表示
    if (result.reservationInfo) {
      const dateObj = new Date(result.reservationInfo.date + 'T' + result.reservationInfo.time);
      const formattedDate = formatDateWithDayJP(dateObj);
      const timeDisplay = result.reservationInfo.endTime ? 
        `${result.reservationInfo.time} 〜 ${result.reservationInfo.endTime}` : 
        result.reservationInfo.time;
      
      document.getElementById('completeDate').textContent = `${formattedDate} ${timeDisplay}`;
    }
    
    // 操作防止用オーバーレイを表示
    const blocker = document.getElementById('interactionBlocker');
    blocker.style.display = 'block';
    
    // 完了モーダルを表示
    const completeModal = new bootstrap.Modal(document.getElementById('reservationCompleteModal'), {
      backdrop: 'static',
      keyboard: false
    });
    
    completeModal.show();
    
    // モーダルを閉じられないように設定を強化
    const modalElement = document.getElementById('reservationCompleteModal');
    modalElement.setAttribute('data-bs-backdrop', 'static');
    modalElement.setAttribute('data-bs-keyboard', 'false');
    
    // モーダル内でのESCキーやクリックイベントを無効化
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // モーダル外のコンテンツへのアクセスを無効化
    document.body.style.overflow = 'hidden';
    
    // 成功メッセージも非表示のまま保持
    const resultElement = document.getElementById('result');
    resultElement.style.display = 'none';
    resultElement.innerHTML = `
      <div class="alert alert-success">
        <i class="bi bi-check-circle me-2"></i>
        ${result.message}<br>
        LINEにも予約確認メッセージを送信しました。
      </div>
    `;
    
  } else {
    // 失敗メッセージを表示
    displayMessage('result', `<i class="bi bi-exclamation-triangle me-2"></i>${result.message}`, 'danger');
  }
}

/**
 * 予約フォームをリセットする
 */
function resetReservationForm() {
  document.getElementById('reservationForm').reset();
  
  // 選択日時表示をリセット
  document.getElementById('selectedDateTime').textContent = '日時を選択してください';
  document.getElementById('selectedDateTime').classList.remove('alert-info');
  document.getElementById('selectedDateTime').classList.add('alert-secondary');
  
  // カレンダーの選択状態を解除
  const previouslySelected = document.querySelector('.time-slot.selected');
  if (previouslySelected) {
    previouslySelected.classList.remove('selected');
  }
  
  // 予約確定ボタンを再度無効化
  document.getElementById('submitBtn').disabled = true;
  
  // カレンダーを更新
  updateCalendar();
}

/**
 * 予約作成失敗時のコールバック関数
 * @param {Error|string} error - エラーオブジェクトまたはメッセージ
 */
function handleReservationFailure(error) {
  console.error('予約失敗:', error);
  
  // エラーメッセージを表示
  displayMessage('result', `
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-circle me-2"></i>
      予約処理中にエラーが発生しました。時間をおいて再度お試しいただくか、別の日時をお選びください。
    </div>
  `, '');
}

function loadReservations() {
  const listDiv = document.getElementById('reservationsList');
  const cancelResultDiv = document.getElementById('cancelResult');
  cancelResultDiv.innerHTML = ''; // 前回のキャンセル結果メッセージをクリア
  
  // ローディング表示
  listDiv.innerHTML = `
    <div class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>予約情報を読み込み中...</p>
    </div>`;

  google.script.run
    .withSuccessHandler(renderReservations)
    .withFailureHandler(error => {
      console.error('予約一覧の取得に失敗しました:', error);
      listDiv.innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>予約情報の読み込みに失敗しました。再度お試しください。
        </div>
      `;
    })
    .getUserReservations(userId);
}

/**
 * 取得した予約情報をもとに一覧を描画する
 * @param {Array<object>} reservations - 予約情報の配列
 */
function renderReservations(reservations) {
  const listDiv = document.getElementById('reservationsList');
  listDiv.innerHTML = ''; // 現在の内容をクリア

  if (!reservations || reservations.length === 0) {
    // 予約がない場合のメッセージを表示
    listDiv.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-calendar-x me-2"></i>現在、有効な予約はありません。
      </div>`;
    return;
  }

  // 予約を日付順にソート
  reservations.sort((a, b) => {
    const dateA = new Date(a.date + 'T' + a.time);
    const dateB = new Date(b.date + 'T' + b.time);
    return dateA - dateB;
  });

// セクションヘッダーを追加
listDiv.innerHTML = `
  <h5 class="border-bottom pb-2 mb-4" style="font-size: 40px;">
    <i class="bi bi-calendar-check me-2"></i>予約一覧
    <span class="badge bg-primary ms-2" style="font-size: 40px;">${reservations.length}件</span>
  </h5>`;

  // 各予約情報をリストアイテムとして追加
  reservations.forEach((res, index) => {
    // 日付をより読みやすくフォーマット
    const dateObj = new Date(res.date + 'T' + res.time);
    const formattedDate = formatDateWithDayJP(dateObj);
    
    // 今日の日付との比較
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const reservationDate = new Date(res.date);
    reservationDate.setHours(0, 0, 0, 0);
    
    // 予約日が今日かどうかをチェック
    const isToday = reservationDate.getTime() === today.getTime();
    
    // 予約日が過去かどうかをチェック
    const isPast = reservationDate < today;
    
    // 時間表示（終了時間がある場合は含める）
    const timeDisplay = res.endTime ? `${res.time} 〜 ${res.endTime}` : res.time;
    
    // カード要素を作成
    const card = document.createElement('div');
    card.className = `card mb-3 reservation-card ${isToday ? 'border-primary' : ''} ${isPast ? 'bg-light' : ''}`;
    card.id = `reservation-${res.id}`;
    
    // カード内容を構築
    card.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center ${isToday ? 'bg-primary text-white' : ''}">
        <div>
          ${isToday ? '<span class="badge bg-warning text-dark me-2">本日</span>' : ''}
          <i class="bi bi-calendar-event me-2"></i>${formattedDate}
        </div>
        <small class="text-${isToday ? 'light' : 'muted'}">予約ID: ${res.id}</small>
      </div>
      <div class="card-body">
        <div class="row">
          <h5 class="card-title">
            <i class="bi bi-clock me-2"></i><strong>時間：</strong>${timeDisplay}
          </h5>
          <p class="card-text">
            <i class="bi bi-person-check me-2"></i><strong>内容：</strong> ${res.description || "パーソナルトレーニング"}
          </p>
        </div>
        <div class="row mt-3">
          <div class="col-12 text-end">
            <button class="btn ${isPast ? 'btn-secondary disabled' : 'btn-outline-danger'} cancel-btn" 
                    data-reservation-id="${res.id}" 
                    ${isPast ? 'disabled' : ''}>
              <i class="bi bi-x-circle me-2"></i>
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              ${isPast ? '予約期間終了' : 'キャンセルする'}
            </button>
          </div>
        </div>
      </div>
    `;
    
    listDiv.appendChild(card);
  });

  // 各キャンセルボタンにクリックイベントリスナーを設定
  listDiv.querySelectorAll('.cancel-btn').forEach(button => {
    button.addEventListener('click', handleCancelButtonClick);
  });
  
  // 確定キャンセルボタンにイベントリスナーを設定
  document.getElementById('confirmCancelBtn').addEventListener('click', handleConfirmCancel);
}

/**
 * キャンセルボタンがクリックされたときの処理（モーダルを表示）
 * @param {Event} event - クリックイベント
 */
function handleCancelButtonClick(event) {
  const button = event.currentTarget; // クリックされたボタン
  const reservationId = button.dataset.reservationId; // data属性から予約IDを取得
  const cancelResultDiv = document.getElementById('cancelResult');
  cancelResultDiv.innerHTML = ''; // 前回のキャンセル結果メッセージをクリア
  
  // 予約カードから予約情報を取得
  const card = button.closest('.reservation-card');
  
  // 日付部分を取得
  const dateElement = card.querySelector('.card-header div');
  let dateText = dateElement.textContent.trim();
  // '本日' バッジがある場合は除去
  if (dateElement.querySelector('.badge')) {
    dateText = dateText.replace(dateElement.querySelector('.badge').textContent.trim(), '').trim();
  }
  
  // 時間部分を取得
  const timeElement = card.querySelector('.card-title');
  // 「時間：」以降のテキストを抽出
  const timeMatch = timeElement.textContent.match(/時間：(.+)/);
  const timeText = timeMatch ? timeMatch[1].trim() : timeElement.textContent.trim();
  
  // 内容部分を取得（存在する場合）
  let contentText = "パーソナルトレーニング"; // デフォルト値
  const contentElement = card.querySelector('.card-text');
  if (contentElement) {
    const contentMatch = contentElement.textContent.match(/内容：(.+)/);
    if (contentMatch) {
      contentText = contentMatch[1].trim();
    }
  }
  
  // モーダルに予約情報をセット
  document.getElementById('modalReservationId').textContent = reservationId;
  document.getElementById('modalReservationDate').textContent = dateText;
  document.getElementById('modalReservationTime').textContent = timeText;
  document.getElementById('modalReservationContent').textContent = contentText;
  
  // 確定キャンセルボタンに予約IDをデータ属性としてセット
  document.getElementById('confirmCancelBtn').dataset.reservationId = reservationId;
  
  // モーダルを表示
  const cancelModal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
  cancelModal.show();
}

/**
 * モーダルでキャンセル確定ボタンがクリックされたときの処理
 * @param {Event} event - クリックイベント
 */
function handleConfirmCancel(event) {
  const button = event.currentTarget; // クリックされたボタン
  const reservationId = button.dataset.reservationId; // data属性から予約IDを取得
  const cancelResultDiv = document.getElementById('cancelResult');
  
  // ボタンを「処理中」表示に変更
  button.disabled = true;
  const spinner = button.querySelector('.spinner-border');
  spinner.classList.remove('d-none'); // スピナーを表示
  
  console.log(`キャンセル実行: ID=${reservationId}, User=${userId}`);
  // サーバーサイド(GAS)のcancelReservation関数を呼び出す
  google.script.run
    .withSuccessHandler(result => {
      // モーダルを閉じる
      const cancelModal = bootstrap.Modal.getInstance(document.getElementById('cancelConfirmModal'));
      cancelModal.hide();
      
      // キャンセル処理結果を反映
      handleCancelSuccess(result, document.querySelector(`.cancel-btn[data-reservation-id="${reservationId}"]`));
      
      // ボタンを元に戻す
      button.disabled = false;
      spinner.classList.add('d-none');
    })
    .withFailureHandler(error => {
      // モーダルを閉じる
      const cancelModal = bootstrap.Modal.getInstance(document.getElementById('cancelConfirmModal'));
      cancelModal.hide();
      
      // エラー処理
      handleCancelFailure(error, document.querySelector(`.cancel-btn[data-reservation-id="${reservationId}"]`));
      
      // ボタンを元に戻す
      button.disabled = false;
      spinner.classList.add('d-none');
    })
    .cancelReservation(reservationId, userId); // 予約IDとユーザーIDを渡す
}

/**
 * 予約キャンセル成功時のコールバック関数
 * @param {object} result - サーバーからの結果 { success: boolean, message: string }
 * @param {HTMLButtonElement} button - クリックされたキャンセルボタン
 */
function handleCancelSuccess(result, button) {
  console.log('キャンセル結果:', result);

  // キャンセル結果メッセージを表示
  if (result.success) {
    // 成功メッセージを表示
    displayMessage('cancelResult', `<i class="bi bi-check-circle me-2"></i>${result.message}`, 'success');
    
    // キャンセルされた予約カードに枠線を追加
    const card = button.closest('.reservation-card');
    card.classList.add('border-danger');
    
    // カードのボディ部分を半透明にする
    const cardBody = card.querySelector('.card-body');
    cardBody.style.opacity = '0.6';
    
    // ボタンのスタイルとテキストを変更
    button.classList.remove('btn-outline-danger');
    button.classList.add('btn-danger');
    button.disabled = true;
    button.innerHTML = 'キャンセル済み';  // アイコンを削除してテキストのみに
    
    // 新規予約タブのカレンダーを更新
    updateCalendar();
  } else {
    // 失敗した場合
    displayMessage('cancelResult', result.message, 'danger');
  }
}

/**
 * 予約キャンセル失敗時のコールバック関数
 * @param {Error|string} error - エラーオブジェクトまたはメッセージ
 */
function handleCancelFailure(error, button) {
  console.error('キャンセルエラー:', error);
  // エラーメッセージを表示
  displayMessage('cancelResult', `
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-triangle-fill text-danger me-2 fs-4"></i>
      <div>キャンセル処理中にエラーが発生しました。時間をおいて再度お試しください。</div>
    </div>
  `, 'danger');
}

/**
 * DateオブジェクトをYYYY-MM-DD 形式の文字列にフォーマットする
 * @param {Date} date - 日付オブジェクト
 * @return {string} - フォーマットされた文字列 (無効な日付の場合は空文字)
 */
function formatDate(date) {
  // Dateオブジェクトでない場合や無効な日付の場合は空文字を返す
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
  try {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0'); // 月は0から始まるため+1
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (error) {
     console.error('formatDateでエラー:', error);
     return '';
  }
}

/**
 * Dateオブジェクトを MM/DD 形式の文字列にフォーマットする
 * @param {Date} date - 日付オブジェクト
 * @return {string} - フォーマットされた文字列 (無効な日付の場合は空文字)
 */
function formatDateMMDD(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
  const month = String(date.getMonth() + 1);
  const day = String(date.getDate());
  return `${month}/${day}`;
}

/**
 * DateオブジェクトをYYYY年M月D日(曜) 形式の日本語文字列にフォーマットする
 * @param {Date} date - 日付オブジェクト
 * @return {string} - フォーマットされた文字列 (無効な日付の場合は空文字)
 */
function formatDateWithDayJP(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const days = ['日', '月', '火', '水', '木', '金', '土'];
  const dayName = days[date.getDay()];
  return `${year}年${month}月${day}日(${dayName})`;
}

/**
 * 週ナビゲーションボタン（前の週、次の週、本日）の有効/無効状態と週表示を更新する
 */
function updateWeekNavigation() {
  const prevWeekBtn = document.getElementById('prevWeek');
  const nextWeekBtn = document.getElementById('nextWeek');
  const todayBtn = document.getElementById('todayBtn');
  const currentWeekDiv = document.getElementById('currentWeek');

  // 表示中の週の終了日を計算（開始日から7日後）
  const weekEndDate = new Date(currentWeekStart);
  weekEndDate.setDate(weekEndDate.getDate() + 6);

  // 週表示エリア (MM/DD 〜 MM/DD) を更新
  currentWeekDiv.textContent = `${formatDateMMDD(currentWeekStart)} 〜 ${formatDateMMDD(weekEndDate)}`;

  // 「前の週」ボタン: 本日より前の週は無効化
  const today = new Date();
  today.setHours(0, 0, 0, 0); // 時刻部分をリセット
  
  // 本日の日付との比較（前の週へのナビゲーションが本日より前の日付にならないようにする）
  const previousWeekStart = new Date(currentWeekStart);
  previousWeekStart.setDate(previousWeekStart.getDate() - 7); // 前の週の開始日
  
  prevWeekBtn.disabled = previousWeekStart < today;

  // 「次の週」ボタン: 予約可能終了日を超える週は無効化
  nextWeekBtn.disabled = weekEndDate >= endDate;
  
  // 「本日」ボタン: 現在表示されている週が本日を含む週なら無効化
  const todayWeekStart = new Date(today);
  const currentWeekStartDay = new Date(currentWeekStart);
  currentWeekStartDay.setHours(0, 0, 0, 0);
  
  // 年月日だけを比較
  const isSameDate = (date1, date2) => {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
  };
  
  // 本日が表示中の週に含まれているかどうかを確認
  const weekContainsToday = () => {
    for (let i = 0; i < 7; i++) {
      const dayInWeek = new Date(currentWeekStart);
      dayInWeek.setDate(currentWeekStart.getDate() + i);
      if (isSameDate(dayInWeek, today)) {
        return true;
      }
    }
    return false;
  };
  
  todayBtn.disabled = weekContainsToday() && isSameDate(currentWeekStartDay, todayWeekStart);
}

/**
 * ローディングインジケーターの表示/非表示を切り替える
 * @param {boolean} isLoading - trueなら表示、falseなら非表示
 */
function showLoading(isLoading) {
  const calendarBody = document.getElementById('calendarBody');
  
  if (isLoading && calendarBody) {
    // ローディング表示
    calendarBody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>予約可能な時間枠を読み込み中...</p>
        </td>
      </tr>
    `;
    
    // ナビゲーションボタンの状態更新
    updateWeekNavigation();
  }
}

/**
 * 指定されたIDの要素にメッセージを表示する
 * @param {string} elementId - メッセージを表示する要素のID
 * @param {string} message - 表示するメッセージHTML
 * @param {string} [type='info'] - Alertのタイプ ('success', 'danger', 'warning', 'info')
 */
function displayMessage(elementId, message, type = 'info') {
  const element = document.getElementById(elementId);
  if (element) {
    if (type) {
      // BootstrapのAlertコンポーネントのHTMLを生成
      element.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      </div>`;
    } else {
      // typeが空の場合は、メッセージをそのまま表示（すでにalert-*クラスが含まれている場合）
      element.innerHTML = message;
    }
  }
}
</script>
</body>
</html>
