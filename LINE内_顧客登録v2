/**
 * - ã€æ”¹è‰¯ç‰ˆã€‘LINEã¨Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é€£æºã—ãŸäºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 * - LINEçµŒç”±ã§äºˆç´„ã‚’å—ã‘ä»˜ã‘ã€Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆç´„æƒ…å ±ã‚’ç™»éŒ²
 * - ã™ã¹ã¦ã®äºˆç´„æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚‚è¨˜éŒ²
 * - äºˆç´„å‰æ—¥ã«LINEã§ãƒªãƒã‚¤ãƒ³ãƒ‰é€šçŸ¥
 * - äºˆç´„ç¢ºèªãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½
 * - ä¼šå“¡æƒ…å ±ç™»éŒ²æ©Ÿèƒ½
 * - ãƒ¢ãƒ€ãƒ³ã§ã‚·ãƒ³ãƒ—ãƒ«ãªUI
 * - å‡¦ç†ã®é«˜é€ŸåŒ–ã¨å®‰å®šæ€§å‘ä¸Š */

// ======= è¨­å®š =======
// äºˆç´„æƒ…å ±ç™»éŒ²å…ˆã®Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID
const CALENDAR_ID = 'c_9d24918fa9b40d73dd51c600630ff38b2a96508a8bf5bb25029a89c91947a105@group.calendar.google.com';

// äºˆç´„æƒ…å ±ä¿å­˜ç”¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
const SPREADSHEET_ID = '1VkxDJDZTeLemU-rARSL_AudtS8RJ7dG4c5xsnD-E6bk'; 

// LINEãƒãƒ£ãƒ³ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
const LINE_ACCESS_TOKEN = 'LvBCTNS/yadS7qKtfOQljrPnSJl8dEEEDmMtU63JWZnIFoqDrM6bfUvrmMSo8WZgBiw525QLmh0XuNEvNPLU/nxqVtnP673rk5qnrTt5H6+MMTrQ4WhrIJoGZHugeqbjM7DRtDEV7HloZD8Y+ATOqQdB04t89/1O/w1cDnyilFU=';

// äºˆç´„ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆè¨­å®š
const BUSINESS_HOURS = {
  start: 10, // äºˆç´„å—ä»˜é–‹å§‹æ™‚é–“ï¼ˆ10æ™‚ï¼‰
  end: 18    // äºˆç´„å—ä»˜çµ‚äº†æ™‚é–“ï¼ˆ18æ™‚ï¼‰
}

// 1äººã‚ãŸã‚Šã®æœ€å¤§äºˆç´„æ•°
const MAX_RESERVATIONS_PER_USER = 3;

// å„æ™‚é–“æ ã®æœ€å¤§äºˆç´„æ•°
const MAX_SLOTS_PER_TIME = 2;

// äºˆç´„å¯èƒ½æ—¥æ•°ï¼ˆä»Šæ—¥ã‹ã‚‰ä½•æ—¥å…ˆã¾ã§äºˆç´„å¯èƒ½ã‹ï¼‰
const DAYS_AHEAD = 100;

// äºˆç´„å¯èƒ½é–‹å§‹æ—¥ï¼ˆä»Šæ—¥ã‹ã‚‰ä½•æ—¥å¾Œã‹ã‚‰äºˆç´„å¯èƒ½ã‹ï¼‰
const MIN_DAYS_AHEAD = 2;

// å®šä¼‘æ—¥ã®è¨­å®šï¼ˆ0:æ—¥æ›œ, 1:æœˆæ›œ, 2:ç«æ›œ, 3:æ°´æ›œ, 4:æœ¨æ›œ, 5:é‡‘æ›œ, 6:åœŸæ›œï¼‰
const CLOSED_DAYS = [0, 4]; // æ—¥æ›œæ—¥ã¨æœ¨æ›œæ—¥ãŒå®šä¼‘æ—¥

// ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š
const TIME_ZONE = 'Asia/Tokyo';

/**
 * äºˆç´„ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
 */
function getOrCreateReservationSheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName('äºˆç´„ãƒªã‚¹ãƒˆ');
  
  if (!sheet) {
    // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
    sheet = ss.insertSheet('äºˆç´„ãƒªã‚¹ãƒˆ');
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®š
    sheet.appendRow([
      'ã‚¤ãƒ™ãƒ³ãƒˆID',
      'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
      'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
      'äºˆç´„æ—¥',
      'äºˆç´„æ™‚é–“',
      'äºˆç´„æ—¥(ISO)',
      'é–‹å§‹æ™‚åˆ»',
      'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
      'ç™»éŒ²æ—¥æ™‚',
      'å‚™è€ƒ'
    ]);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ›¸å¼è¨­å®š
    sheet.getRange(1, 1, 1, 10).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    // åˆ—å¹…ã®èª¿æ•´
    sheet.setColumnWidth(1, 300); // ã‚¤ãƒ™ãƒ³ãƒˆID
    sheet.setColumnWidth(2, 150); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    sheet.setColumnWidth(3, 150); // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    sheet.setColumnWidth(4, 150); // äºˆç´„æ—¥
    sheet.setColumnWidth(5, 100); // äºˆç´„æ™‚é–“
    sheet.setColumnWidth(6, 100); // äºˆç´„æ—¥(ISO)
    sheet.setColumnWidth(7, 80);  // é–‹å§‹æ™‚åˆ»
    sheet.setColumnWidth(8, 100); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    sheet.setColumnWidth(9, 150); // ç™»éŒ²æ—¥æ™‚
    sheet.setColumnWidth(10, 250); // å‚™è€ƒ
  }
  
  return sheet;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
 */
function getOrCreateUserTempSheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿');
  
  if (!sheet) {
    // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
    sheet = ss.insertSheet('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿');
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®š
    sheet.appendRow([
      'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
      'ã‚­ãƒ¼',
      'å€¤',
      'æ›´æ–°æ—¥æ™‚'
    ]);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ›¸å¼è¨­å®š
    sheet.getRange(1, 1, 1, 4).setFontWeight('bold');
    sheet.setFrozenRows(1);
  }
  
  return sheet;
}

/**
 * ä¼šå“¡æƒ…å ±ä¿å­˜ç”¨ã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
 */
function getOrCreateMemberSheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName('ä¼šå“¡ãƒªã‚¹ãƒˆ');
  
  if (!sheet) {
    // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
    sheet = ss.insertSheet('ä¼šå“¡ãƒªã‚¹ãƒˆ');
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®š
    sheet.appendRow([
      'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
      'æ°å',
      'ãƒ•ãƒªã‚¬ãƒŠ',
      'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
      'çŸ¥ã£ãŸãã£ã‹ã‘',
      'ç™»éŒ²æ—¥æ™‚',
      'æ›´æ–°æ—¥æ™‚',
      'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
    ]);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ›¸å¼è¨­å®š
    sheet.getRange(1, 1, 1, 8).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    // åˆ—å¹…ã®èª¿æ•´
    sheet.setColumnWidth(1, 150); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    sheet.setColumnWidth(2, 150); // æ°å
    sheet.setColumnWidth(3, 150); // ãƒ•ãƒªã‚¬ãƒŠ
    sheet.setColumnWidth(4, 200); // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    sheet.setColumnWidth(5, 200); // çŸ¥ã£ãŸãã£ã‹ã‘
    sheet.setColumnWidth(6, 150); // ç™»éŒ²æ—¥æ™‚
    sheet.setColumnWidth(7, 150); // æ›´æ–°æ—¥æ™‚
    sheet.setColumnWidth(8, 100); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  }
  
  return sheet;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
 */
function saveUserTemp(userId, key, value) {
  const sheet = getOrCreateUserTempSheet();
  const data = sheet.getDataRange().getValues();
  
  // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä¸Šæ›¸ã
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId && data[i][1] === key) {
      sheet.getRange(i + 1, 3).setValue(value);
      sheet.getRange(i + 1, 4).setValue(new Date());
      return;
    }
  }
  
  // æ–°è¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
  sheet.appendRow([userId, key, value, new Date()]);
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
 */
function getUserTemp(userId, key) {
  const sheet = getOrCreateUserTempSheet();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId && data[i][1] === key) {
      return data[i][2];
    }
  }
  
  return null;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
 */
function removeUserTemp(userId) {
  const sheet = getOrCreateUserTempSheet();
  const data = sheet.getDataRange().getValues();
  
  // å‰Šé™¤å¯¾è±¡ã®è¡Œã‚’ç‰¹å®š
  const rowsToDelete = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId) {
      rowsToDelete.push(i + 1);
    }
  }
  
  // è¡Œã‚’å‰Šé™¤ï¼ˆå¾Œã‚ã‹ã‚‰é †ã«å‰Šé™¤ï¼‰
  for (let i = rowsToDelete.length - 1; i >= 0; i--) {
    sheet.deleteRow(rowsToDelete[i]);
  }
}

/**
 * ä¼šå“¡æƒ…å ±ã‚’ä¿å­˜
 */
function saveMemberInfo(userId, memberInfo) {
  const sheet = getOrCreateMemberSheet();
  const data = sheet.getDataRange().getValues();
  const now = new Date();
  
  // æ—¢å­˜ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°æ›´æ–°
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId) {
      sheet.getRange(i + 1, 2).setValue(memberInfo.name);
      sheet.getRange(i + 1, 3).setValue(memberInfo.kana);
      sheet.getRange(i + 1, 4).setValue(memberInfo.email);
      sheet.getRange(i + 1, 5).setValue(memberInfo.referral);
      sheet.getRange(i + 1, 7).setValue(now); // æ›´æ–°æ—¥æ™‚
      return true;
    }
  }
  
  // æ–°è¦ä¼šå“¡ã®è¿½åŠ 
  sheet.appendRow([
    userId,
    memberInfo.name,
    memberInfo.kana,
    memberInfo.email,
    memberInfo.referral,
    now, // ç™»éŒ²æ—¥æ™‚
    now, // æ›´æ–°æ—¥æ™‚
    'ç™»éŒ²æ¸ˆ' // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  ]);
  
  return true;
}

/**
 * ä¼šå“¡æƒ…å ±ã‚’å–å¾—
 */
function getMemberInfo(userId) {
  const sheet = getOrCreateMemberSheet();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId) {
      return {
        name: data[i][1],
        kana: data[i][2],
        email: data[i][3],
        referral: data[i][4],
        registrationDate: data[i][5],
        updateDate: data[i][6],
        status: data[i][7]
      };
    }
  }
  
  return null;
}

/**
 * å®šæœŸå®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 */
function setupTriggers() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'sendDailyReminders') {
      ScriptApp.deleteTrigger(trigger);
    }
  }
  
  // æ¯æ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
  ScriptApp.newTrigger('sendDailyReminders')
    .timeBased()
    .atHour(9)
    .everyDays(1)
    .inTimezone(TIME_ZONE)
    .create();
  
  console.log("ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
}

/**
 * äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡ï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
 */
function sendDailyReminders() {
  console.log("æ—¥æ¬¡äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡é–‹å§‹");
  
  // æ˜æ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0);
  
  // æ˜æ—¥ã®çµ‚æ—¥
  const tomorrowEnd = new Date(tomorrow);
  tomorrowEnd.setHours(23, 59, 59, 999);
  
  // æ˜æ—¥ã®äºˆç´„ã‚’å–å¾—
  const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
  const events = calendar.getEvents(tomorrow, tomorrowEnd);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®äºˆç´„ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const userReservations = {};
  
  events.forEach(event => {
    const title = event.getTitle();
    const match = title.match(/\((.*?)\)/);
    if (!match) return;
    
    const userId = match[1];
    if (!userReservations[userId]) {
      userReservations[userId] = [];
    }
    
    userReservations[userId].push(event);
  });
  
  // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡
  for (const userId in userReservations) {
    const userEvents = userReservations[userId];
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆç´„ã‚’æ—¥æ™‚é †ã«ã‚½ãƒ¼ãƒˆ
    userEvents.sort((a, b) => a.getStartTime() - b.getStartTime());
    
    // äºˆç´„æƒ…å ±ã‚’FlexMessageã¨ã—ã¦é€ä¿¡
    sendReminderFlexMessage(userId, userEvents);
  }
  
  console.log("æ—¥æ¬¡äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡å®Œäº†");
}

/**
 * æŒ‡å®šæ—¥ã®äºˆç´„å¯èƒ½ãªæ™‚é–“æ ã‚’å–å¾—
 */
function getAvailableTimeSlots(date) {
  console.log(`äºˆç´„å¯èƒ½æ™‚é–“ã‚’å–å¾—: ${date}`);
  
  // æŒ‡å®šæ—¥ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
  const events = getCalendarEvents(date);
  
  // æ™‚é–“ã”ã¨ã®äºˆç´„æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  const bookedSlots = {};
  events.forEach(event => {
    const hour = event.getStartTime().getHours();
    bookedSlots[hour] = (bookedSlots[hour] || 0) + 1;
  });
  
  // äºˆç´„å¯èƒ½ãªæ™‚é–“æ ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
  const availableTimeSlots = [];
  for (let hour = BUSINESS_HOURS.start; hour < BUSINESS_HOURS.end; hour++) {
    // äºˆç´„æ•°ãŒMAX_SLOTS_PER_TIMEæœªæº€ã®æ™‚é–“ã®ã¿è¡¨ç¤º
    if ((bookedSlots[hour] || 0) < MAX_SLOTS_PER_TIME) {
      availableTimeSlots.push({
        hour: hour,
        display: `${hour}:00ï½${hour + 1}:00`
      });
    }
  }
  
  return availableTimeSlots;
}

/**
 * æŒ‡å®šæ—¥ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
 */
function getCalendarEvents(date) {
  // æŒ‡å®šæ—¥ã®0æ™‚
  const startDate = new Date(date);
  startDate.setHours(0, 0, 0, 0);
  
  // æŒ‡å®šæ—¥ã®23æ™‚59åˆ†
  const endDate = new Date(date);
  endDate.setHours(23, 59, 59, 999);
  
  const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
  return calendar.getEvents(startDate, endDate);
}

/**
 * æ™‚é–“é¸æŠå¾Œã®å‡¦ç†
 */
function handleHourSelection(replyToken, userId, selectedHour) {
  console.log(`æ™‚é–“é¸æŠå‡¦ç†: ${selectedHour}æ™‚`);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¸æŠã—ãŸæ—¥ä»˜ã‚’å–å¾—
  const selectedDate = getUserTemp(userId, "selectedDate");
  if (!selectedDate) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: "äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€Œäºˆç´„ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚"
    }]);
    return;
  }
  
  // æ—¥ä»˜æ–‡å­—åˆ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
  const date = parseDateString(selectedDate);
  if (!date) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: "æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€Œäºˆç´„ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚"
    }]);
    return;
  }
  
  // äºˆç´„æ™‚é–“è¨­å®š
  date.setHours(selectedHour, 0, 0, 0);
  const endTime = new Date(date);
  endTime.setHours(selectedHour + 1, 0, 0, 0);
  
  // äºˆç´„æ ãŒç©ºã„ã¦ã„ã‚‹ã‹ç¢ºèª
  const events = getCalendarEvents(date);
  let bookedCount = 0;
  
  events.forEach(event => {
    if (event.getStartTime().getHours() === selectedHour) {
      bookedCount++;
    }
  });
  
  if (bookedCount >= MAX_SLOTS_PER_TIME) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã®æ™‚é–“ã¯ã™ã§ã«äºˆç´„ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã™ã€‚åˆ¥ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
    }]);
    return;
  }
  
  // äºˆç´„æƒ…å ±ã®ä¸€æ™‚ä¿å­˜ï¼ˆç›´æ¥äºˆç´„ç¢ºå®šã®ãŸã‚ï¼‰
  saveUserTemp(userId, "confirmDate", date.toISOString());
  saveUserTemp(userId, "confirmHour", selectedHour);
  
  // äºˆç´„ã‚’ç›´æ¥ç¢ºå®šã™ã‚‹
  finalizeReservation(replyToken, userId);
}

/**
 * äºˆç´„ã‚’æœ€çµ‚ç¢ºå®šã™ã‚‹
 */
function finalizeReservation(replyToken, userId) {
  // ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰äºˆç´„æƒ…å ±ã‚’å–å¾—
  const dateStr = getUserTemp(userId, "confirmDate");
  const selectedHour = getUserTemp(userId, "confirmHour");
  
  if (!dateStr || !selectedHour) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: "äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€Œäºˆç´„ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚"
    }]);
    return;
  }
  
  // æ—¥ä»˜ã¨æ™‚é–“ã®å¾©å…ƒ
  const date = new Date(dateStr);
  const hour = parseInt(selectedHour);
  
  // çµ‚äº†æ™‚é–“ã®è¨­å®š
  const endTime = new Date(date);
  endTime.setHours(hour + 1, 0, 0, 0);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
  const userName = getUserDisplayName(userId);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨äºˆç´„IDç”¨ã«LINE IDã‚’å«ã‚ã‚‹ï¼‰
  const eventTitle = `äºˆç´„è€…å: ${userName} \nãƒ¦ãƒ¼ã‚¶ãƒ¼ID: (${userId})`;
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆç´„ã‚’è¿½åŠ 
  try {
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    const event = calendar.createEvent(
      eventTitle,
      date,
      endTime,
      {
        description: `LINEäºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®äºˆç´„\nãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}\nãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${userName}\näºˆç´„æ—¥æ™‚: ${formatDateWithDay(date)} ${hour}:00ï½${hour+1}:00`
      }
    );
    
    // ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ä½¿ç”¨ï¼‰
    const eventId = event.getId();
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚‚äºˆç´„æƒ…å ±ã‚’è¨˜éŒ²
    recordReservationToSheet({
      eventId: eventId,
      userId: userId,
      userName: userName,
      date: formatDateWithDay(date),
      time: `${hour}:00ï½${hour+1}:00`,
      isoDate: Utilities.formatDate(date, TIME_ZONE, 'yyyy-MM-dd'),
      startHour: hour,
      status: "äºˆç´„æ¸ˆ",
      timestamp: new Date()
    });
    
    // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    removeUserTemp(userId);
    
    // äºˆç´„å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    sendCompletionMessage(replyToken, formatDateWithDay(date), `${hour}:00ï½${hour+1}:00`);
    
  } catch (error) {
    console.error("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "äºˆç´„ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * äºˆç´„å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
 */
function sendCompletionMessage(replyToken, dateStr, timeStr) {
  const completionMessage = {
    "type": "flex",
    "altText": "äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "äºˆç´„ç¢ºå®š",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#28A745",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä»¥ä¸‹ã®å†…å®¹ã§äºˆç´„ã‚’æ‰¿ã‚Šã¾ã—ãŸ",
            "size": "sm",
            "color": "#888888",
            "align": "center",
            "margin": "md"
          },
          {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "spacing": "sm",
            "contents": [
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "æ—¥ä»˜",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": dateStr,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "wrap": true,
                    "flex": 2
                  }
                ]
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "æ™‚é–“",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": timeStr,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "flex": 2
                  }
                ],
                "margin": "sm"
              }
            ]
          },
          {
            "type": "text",
            "text": "â€»äºˆç´„ã®å‰æ—¥ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™",
            "margin": "xxl",
            "size": "xs",
            "color": "#888888",
            "align": "center",
            "wrap": true
          }
        ]
      },
    }
  };
  
  sendLineMessage(replyToken, [completionMessage]);
}

/**
 * äºˆç´„ç¢ºèªå‡¦ç†
 */
function handleReservationConfirmation(replyToken, userId) {
  console.log(`äºˆç´„ç¢ºèªå‡¦ç†é–‹å§‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId}`);
  
  try {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆç´„ã‚’å–å¾—
    const reservations = getUserFutureReservations(userId);
    console.log(`å–å¾—ã—ãŸäºˆç´„æ•°: ${reservations.length}`);
    
    if (reservations.length === 0) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œäºˆç´„ã€ã¨é€ä¿¡ã—ã¦æ–°ã—ã„äºˆç´„ã‚’ä½œæˆã§ãã¾ã™ã€‚",
        quickReply: {
          items: [{
            type: "action",
            action: {
              type: "message",
              label: "äºˆç´„ã™ã‚‹",
              text: "äºˆç´„"
            }
          }]
        }
      }]);
      return;
    }
    
    // Flex Messageã§äºˆç´„ä¸€è¦§ã‚’è¡¨ç¤º
    sendReservationListFlexMessage(replyToken, userId, reservations);
    
  } catch (error) {
    console.error("äºˆç´„ç¢ºèªå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error, error.stack);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "äºˆç´„æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * äºˆç´„ä¸€è¦§ã‚’FlexMessageã§è¡¨ç¤º
 */
function sendReservationListFlexMessage(replyToken, userId, reservations) {
  try {
    // æœ€å¤§5ä»¶ã®äºˆç´„ã‚’è¡¨ç¤º
    const displayReservations = reservations.slice(0, 5);
    
    // äºˆç´„ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (displayReservations.length === 0) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œäºˆç´„ã€ã¨é€ä¿¡ã—ã¦æ–°ã—ã„äºˆç´„ã‚’ä½œæˆã§ãã¾ã™ã€‚",
        quickReply: {
          items: [{
            type: "action",
            action: {
              type: "message",
              label: "äºˆç´„ã™ã‚‹",
              text: "äºˆç´„"
            }
          }]
        }
      }]);
      return;
    }
    
    // å„äºˆç´„ã®ã‚«ãƒ¼ãƒ‰é …ç›®ã‚’ä½œæˆ
    const reservationItems = displayReservations.map((reservation, index) => {
      const startTime = reservation.getStartTime();
      const endTime = reservation.getEndTime();
      const eventId = reservation.getId();
      
      const dateStr = formatDateWithDay(startTime);
      const timeStr = `${startTime.getHours()}:00ï½${endTime.getHours()}:00`;
      
      return {
        "type": "box",
        "layout": "vertical",
        "margin": "xxl",
        "spacing": "sm",
        "contents": [
          {
            "type": "text",
            "text": `äºˆç´„ ${index + 1}`,
            "size": "xs",
            "color": "#aaaaaa",
            "weight": "bold"
          },
          {
            "type": "box",
            "layout": "horizontal",
            "contents": [
              {
                "type": "text",
                "text": "æ—¥ä»˜",
                "size": "sm",
                "color": "#555555",
                "flex": 1
              },
              {
                "type": "text",
                "text": dateStr,
                "size": "sm",
                "color": "#111111",
                "align": "end",
                "wrap": true,
                "flex": 2
              }
            ]
          },
          {
            "type": "box",
            "layout": "horizontal",
            "contents": [
              {
                "type": "text",
                "text": "æ™‚é–“",
                "size": "sm",
                "color": "#555555",
                "flex": 1
              },
              {
                "type": "text",
                "text": timeStr,
                "size": "sm",
                "color": "#111111",
                "align": "end",
                "flex": 2
              }
            ]
          },
          {
            "type": "button",
            "style": "link",
            "height": "sm",
            "action": {
              "type": "message",
              "label": "ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
              "text": `ã‚­ãƒ£ãƒ³ã‚»ãƒ«:${eventId}`
            },
            "color": "#ff5551",
            "margin": "md"
          }
        ]
      };
    });
    
    // äºˆç´„ä¸€è¦§ã®FlexMessage
    const flexMessage = {
      "type": "flex",
      "altText": "äºˆç´„ä¸€è¦§",
      "contents": {
        "type": "bubble",
        "size": "mega",
        "header": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "ç¾åœ¨ã®äºˆç´„ä¸€è¦§",
              "weight": "bold",
              "size": "lg",
              "align": "center",
              "color": "#ffffff"
            }
          ],
          "backgroundColor": "#28A745",
          "paddingTop": "md",
          "paddingBottom": "md"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": reservationItems.length > 0 ? reservationItems : [{
            "type": "text",
            "text": "ç¾åœ¨ã€äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
            "size": "md",
            "color": "#555555",
            "align": "center",
            "margin": "xl"
          }]
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "button",
              "style": "primary",
              "action": {
                "type": "message",
                "label": "æ–°è¦äºˆç´„",
                "text": "äºˆç´„"
              },
              "color": "#28A745"
            }
          ]
        }
      }
    };
    
    sendLineMessage(replyToken, [flexMessage]);
    
  } catch (error) {
    console.error("äºˆç´„ä¸€è¦§FlexMessageä½œæˆã‚¨ãƒ©ãƒ¼:", error);
    
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å¯¾å¿œ
    const fallbackMessage = {
      type: "text",
      text: "äºˆç´„ä¸€è¦§ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      quickReply: {
        items: [{
          type: "action",
          action: {
            type: "message",
            label: "äºˆç´„ã™ã‚‹",
            text: "äºˆç´„"
          }
        }]
      }
    };
    
    sendLineMessage(replyToken, [fallbackMessage]);
  }
}

/**
 * äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
 */
function handleCancellationConfirmation(replyToken, userId, eventId) {
  console.log(`äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèª: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId}, ã‚¤ãƒ™ãƒ³ãƒˆID ${eventId}`);
  
  try {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    const event = calendar.getEventById(eventId);
    
    if (!event) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "æŒ‡å®šã•ã‚ŒãŸäºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã™ã§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‹ã€å­˜åœ¨ã—ãªã„äºˆç´„ã§ã™ã€‚"
      }]);
      return;
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æŠ½å‡ºã—ã¦æ¨©é™ãƒã‚§ãƒƒã‚¯
    const title = event.getTitle();
    const description = event.getDescription();
    let userIdInEvent = null;
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰æ¤œç´¢
    const titleMatch = title.match(/\((.*?)\)/);
    if (titleMatch) {
      userIdInEvent = titleMatch[1];
    }
    
    // ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
    if (!userIdInEvent && description) {
      const descMatch = description.match(/ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: (.*?)(\n|$)/);
      if (descMatch) {
        userIdInEvent = descMatch[1];
      }
    }
    
    if (!userIdInEvent || userIdInEvent !== userId) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
      }]);
      return;
    }
    
    // äºˆç´„æƒ…å ±ã‚’å–å¾—
    const startTime = event.getStartTime();
    const endTime = event.getEndTime();
    const dateStr = formatDateWithDay(startTime);
    const timeStr = `${startTime.getHours()}:00ï½${endTime.getHours()}:00`;
    
    // ä¸€æ™‚ä¿å­˜
    saveUserTemp(userId, "cancelEventId", eventId);
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªç”¨FlexMessage
    const cancelConfirmMessage = {
      "type": "flex",
      "altText": "äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç¢ºèª",
      "contents": {
        "type": "bubble",
        "size": "kilo",
        "header": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç¢ºèªğŸ˜¢",
              "weight": "bold",
              "size": "lg",
              "align": "center",
              "color": "#ffffff"
            }
          ],
          "backgroundColor": "#696969",
          "paddingTop": "md",
          "paddingBottom": "md"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "ä»¥ä¸‹ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ",
              "size": "sm",
              "color": "#888888",
              "align": "center",
              "margin": "md"
            },
            {
              "type": "box",
              "layout": "vertical",
              "margin": "lg",
              "spacing": "sm",
              "contents": [
                {
                  "type": "box",
                  "layout": "horizontal",
                  "contents": [
                    {
                      "type": "text",
                      "text": "æ—¥ä»˜",
                      "size": "sm",
                      "color": "#555555",
                      "flex": 1
                    },
                    {
                      "type": "text",
                      "text": dateStr,
                      "size": "sm",
                      "color": "#111111",
                      "align": "end",
                      "wrap": true,
                      "flex": 2
                    }
                  ]
                },
                {
                  "type": "box",
                  "layout": "horizontal",
                  "contents": [
                    {
                      "type": "text",
                      "text": "æ™‚é–“",
                      "size": "sm",
                      "color": "#555555",
                      "flex": 1
                    },
                    {
                      "type": "text",
                      "text": timeStr,
                      "size": "sm",
                      "color": "#111111",
                      "align": "end",
                      "flex": 2
                    }
                  ],
                  "margin": "sm"
                }
              ]
            }
          ]
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "spacing": "sm",
          "contents": [
            {
              "type": "button",
              "style": "primary",
              "action": {
                "type": "message",
                "label": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹",
                "text": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹"
              },
              "color": "#696969"
            },
            {
              "type": "button",
              "style": "secondary",
              "action": {
                "type": "message",
                "label": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„",
                "text": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„"
              }
            }
          ]
        }
      }
    };
    
    sendLineMessage(replyToken, [cancelConfirmMessage]);
    
  } catch (error) {
    console.error("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ï¼ˆç¢ºå®šï¼‰
 */
function handleCancellationConfirmed(replyToken, userId) {
  console.log(`äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºå®š: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId}`);
  
  try {
    // ä¸€æ™‚ä¿å­˜ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å–å¾—
    const eventId = getUserTemp(userId, "cancelEventId");
    if (!eventId) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€Œäºˆç´„ç¢ºèªã€ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚"
      }]);
      return;
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    const event = calendar.getEventById(eventId);
    
    if (!event) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "æŒ‡å®šã•ã‚ŒãŸäºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã™ã§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‹ã€å­˜åœ¨ã—ãªã„äºˆç´„ã§ã™ã€‚"
      }]);
      removeUserTemp(userId);
      return;
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æŠ½å‡ºã—ã¦æ¨©é™ãƒã‚§ãƒƒã‚¯
    const title = event.getTitle();
    const userIdInEvent = title.match(/\((.*?)\)/);
    
    if (!userIdInEvent || userIdInEvent[1] !== userId) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
      }]);
      removeUserTemp(userId);
      return;
    }
    
    // äºˆç´„æƒ…å ±ã‚’å–å¾—ã—ã¦ã‹ã‚‰å‰Šé™¤
    const startTime = event.getStartTime();
    const endTime = event.getEndTime();
    const dateStr = formatDateWithDay(startTime);
    const timeStr = `${startTime.getHours()}:00ï½${endTime.getHours()}:00`;
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    updateReservationStatus(eventId, "ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆ", `${userId}ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆ${new Date()}ï¼‰`);
    
    // ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
    event.deleteEvent();
    
    // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    removeUserTemp(userId);
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    sendCancellationCompleteMessage(replyToken, dateStr, timeStr);
    
  } catch (error) {
    console.error("ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
 */
function sendCancellationCompleteMessage(replyToken, dateStr, timeStr) {
  const completeMessage = {
    "type": "flex",
    "altText": "äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#696969",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä»¥ä¸‹ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ",
            "size": "sm",
            "color": "#888888",
            "align": "center",
            "margin": "md"
          },
          {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "spacing": "sm",
            "contents": [
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "æ—¥ä»˜",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": dateStr,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "wrap": true,
                    "flex": 2
                  }
                ]
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "æ™‚é–“",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": timeStr,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "flex": 2
                  }
                ],
                "margin": "sm"
              }
            ]
          }
        ]
      },
    }
  };
  
  sendLineMessage(replyToken, [completeMessage]);
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»Šå¾Œã®äºˆç´„ä¸€è¦§ã‚’å–å¾—
 */
function getUserFutureReservations(userId) {
  console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼äºˆç´„å–å¾—: ${userId}`);
  
  try {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ä»Šå¾Œã®äºˆç´„ã‚’å–å¾—
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰äºˆç´„ã‚’å–å¾—ï¼ˆä»Šæ—¥ã‹ã‚‰30æ—¥å¾Œã¾ã§ï¼‰
    const endDate = new Date(today);
    endDate.setDate(today.getDate() + DAYS_AHEAD);
    
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®å–å¾—
    let events = [];
    try {
      events = calendar.getEvents(today, endDate);
      console.log(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ ${events.length} ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—`);
    } catch (calError) {
      console.error("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", calError);
      events = []; // ç©ºã®é…åˆ—ã§åˆæœŸåŒ–
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå«ã¾ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ã‚’æŠ½å‡º
    // ä¿®æ­£: ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä¸¡æ–¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ¤œç´¢
    const userEvents = events.filter(event => {
      try {
        const title = event.getTitle();
        const description = event.getDescription();
        
        // ä¿®æ­£: ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«å½¢å¼ã¨ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä¸¡æ–¹ã‚’ç¢ºèª
        return (
          title.includes(`(${userId})`) || 
          title.includes(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: (${userId})`) ||
          (description && description.includes(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`))
        );
      } catch (e) {
        console.error("ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
        return false;
      }
    });
    
    console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®äºˆç´„: ${userEvents.length} ä»¶`);
    
    // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
    userEvents.sort((a, b) => a.getStartTime() - b.getStartTime());
    
    return userEvents;
  } catch (error) {
    console.error("äºˆç´„å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    return []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã®é…åˆ—ã‚’è¿”ã™
  }
}

/**
 * LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
 */
function getUserProfile(userId) {
  const url = `https://api.line.me/v2/bot/profile/${userId}`;
  const options = {
    method: "get",
    headers: {
      "Authorization": `Bearer ${LINE_ACCESS_TOKEN}`
    },
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    if (response.getResponseCode() === 200) {
      return JSON.parse(response.getContentText());
    }
    console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", response.getContentText());
    return null;
  } catch (error) {
    console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ä¾‹å¤–:", error);
    return null;
  }
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºåã‚’å–å¾—
 */
function getUserDisplayName(userId) {
  try {
    // ä¼šå“¡æƒ…å ±ã‚’æœ€åˆã«ãƒã‚§ãƒƒã‚¯
    const memberInfo = getMemberInfo(userId);
    if (memberInfo && memberInfo.name) {
      return memberInfo.name;
    }
    
    // ä¼šå“¡æƒ…å ±ãŒãªã‘ã‚Œã°LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½¿ç”¨
    const userProfile = getUserProfile(userId);
    if (userProfile && userProfile.displayName) {
      return userProfile.displayName;
    }
  } catch (e) {
    console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
  }
  return "ãŠå®¢æ§˜";
}

/**
 * postbackã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
 */
function handlePostback(event) {
  const userId = event.source.userId;
  const replyToken = event.replyToken;
  const data = event.postback.data;
  
  if (data.startsWith('action=confirm_reservation')) {
    finalizeReservation(replyToken, userId);
  }
}

/**
 * ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹å§‹
 */
function startMemberRegistration(replyToken, userId) {
  console.log(`ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ é–‹å§‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId}`);
  
  // æ—¢å­˜ä¼šå“¡æƒ…å ±ãƒã‚§ãƒƒã‚¯
  const existingMember = getMemberInfo(userId);
  
  if (existingMember) {
    // æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å ´åˆã¯æƒ…å ±ã‚’è¡¨ç¤º
    sendMemberInfoView(replyToken, userId, existingMember);
    return;
  }
  
  // å¤ã„ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
  removeUserTemp(userId);
  
  // åˆæœŸã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®š
  saveUserTemp(userId, "member_step", "name_input");
  
  // ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ°åå…¥åŠ›ï¼‰ã‚’è¡¨ç¤º
  sendNameInputForm(replyToken);
}

/**
 * æ°åå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
 */
function sendNameInputForm(replyToken) {
  const nameInputMessage = {
    "type": "flex",
    "altText": "ä¼šå“¡ç™»éŒ²: ãŠåå‰å…¥åŠ›",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä¼šå“¡æƒ…å ±ç™»éŒ² (1/4)",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#4285F4",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
            "size": "md",
            "weight": "bold",
            "margin": "md"
          },
          {
            "type": "text",
            "text": "ä¾‹: å±±ç”° å¤ªéƒ",
            "size": "sm",
            "color": "#888888",
            "margin": "sm"
          }
        ],
        "paddingBottom": "md"
      }
    }
  };
  
  sendLineMessage(replyToken, [nameInputMessage]);
}

/**
 * ãƒ•ãƒªã‚¬ãƒŠå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
 */
function sendKanaInputForm(replyToken) {
  const kanaInputMessage = {
    "type": "flex",
    "altText": "ä¼šå“¡ç™»éŒ²: ãƒ•ãƒªã‚¬ãƒŠå…¥åŠ›",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä¼šå“¡æƒ…å ±ç™»éŒ² (2/4)",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#4285F4",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ãƒ•ãƒªã‚¬ãƒŠã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
            "size": "md",
            "weight": "bold",
            "margin": "md"
          },
          {
            "type": "text",
            "text": "ä¾‹: ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦",
            "size": "sm",
            "color": "#888888",
            "margin": "sm"
          }
        ],
        "paddingBottom": "md"
      }
    }
  };
  
  sendLineMessage(replyToken, [kanaInputMessage]);
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
 */
function sendEmailInputForm(replyToken) {
  const emailInputMessage = {
    "type": "flex",
    "altText": "ä¼šå“¡ç™»éŒ²: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä¼šå“¡æƒ…å ±ç™»éŒ² (3/4)",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#4285F4",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
            "size": "md",
            "weight": "bold",
            "margin": "md"
          },
          {
            "type": "text",
            "text": "ä¾‹: example@gmail.com",
            "size": "sm",
            "color": "#888888",
            "margin": "sm"
          }
        ],
        "paddingBottom": "md"
      }
    }
  };
  
  sendLineMessage(replyToken, [emailInputMessage]);
}

/**
 * çŸ¥ã£ãŸãã£ã‹ã‘é¸æŠãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
 */
function sendReferralForm(replyToken) {
  const referralMessage = {
    "type": "flex",
    "altText": "ä¼šå“¡ç™»éŒ²: çŸ¥ã£ãŸãã£ã‹ã‘",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä¼šå“¡æƒ…å ±ç™»éŒ² (4/4)",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#4285F4",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "å½“åº—ã‚’çŸ¥ã£ãŸãã£ã‹ã‘ã‚’é¸æŠã—ã¦ãã ã•ã„",
            "size": "md",
            "weight": "bold",
            "wrap": true,
            "margin": "md"
          }
        ],
        "paddingBottom": "md"
      },
      "footer": {
        "type": "box",
        "layout": "vertical",
        "spacing": "sm",
        "contents": [
          {
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¤œç´¢",
              "text": "ãã£ã‹ã‘:ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¤œç´¢"
            },
            "color": "#4285F4"
          },
          {
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "SNS",
              "text": "ãã£ã‹ã‘:SNS"
            },
            "color": "#4285F4",
            "margin": "sm"
          },
          {
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "çŸ¥äººã®ç´¹ä»‹",
              "text": "ãã£ã‹ã‘:çŸ¥äººã®ç´¹ä»‹"
            },
            "color": "#4285F4",
            "margin": "sm"
          },
          {
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "ãƒãƒ©ã‚·ãƒ»åºƒå‘Š",
              "text": "ãã£ã‹ã‘:ãƒãƒ©ã‚·ãƒ»åºƒå‘Š"
            },
            "color": "#4285F4",
            "margin": "sm"
          },
          {
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "ãã®ä»–",
              "text": "ãã£ã‹ã‘:ãã®ä»–"
            },
            "color": "#4285F4",
            "margin": "sm"
          }
        ]
      }
    }
  };
  
  sendLineMessage(replyToken, [referralMessage]);
}

/**
 * ä¼šå“¡æƒ…å ±å…¥åŠ›ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
 */
function sendMemberConfirmationForm(replyToken, userId) {
  console.log(`ä¼šå“¡æƒ…å ±ç¢ºèªç”»é¢ã‚’è¡¨ç¤º: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId}`);
  
  try {
    // ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¼šå“¡æƒ…å ±ã‚’å–å¾—
    const name = getUserTemp(userId, "member_name");
    const kana = getUserTemp(userId, "member_kana");
    const email = getUserTemp(userId, "member_email");
    const referral = getUserTemp(userId, "member_referral");
    
    if (!name || !kana || !email || !referral) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ä¼šå“¡æƒ…å ±ãŒä¸å®Œå…¨ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã€Œä¼šå“¡ç™»éŒ²ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚"
      }]);
      return;
    }
    
    // ä¼šå“¡æƒ…å ±ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ 
    const confirmationMessage = {
      "type": "flex",
      "altText": "ä¼šå“¡ç™»éŒ²: ç¢ºèª",
      "contents": {
        "type": "bubble",
        "size": "kilo",
        "header": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "ä¼šå“¡æƒ…å ±ç¢ºèª",
              "weight": "bold",
              "size": "lg",
              "align": "center",
              "color": "#ffffff"
            }
          ],
          "backgroundColor": "#4285F4",
          "paddingTop": "md",
          "paddingBottom": "md"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "ä»¥ä¸‹ã®å†…å®¹ã§ç™»éŒ²ã—ã¾ã™",
              "size": "sm",
              "color": "#888888",
              "align": "center",
              "margin": "md"
            },
            {
              "type": "box",
              "layout": "vertical",
              "margin": "lg",
              "spacing": "sm",
              "contents": [
                {
                  "type": "box",
                  "layout": "horizontal",
                  "contents": [
                    {
                      "type": "text",
                      "text": "æ°å",
                      "size": "sm",
                      "color": "#555555",
                      "flex": 1
                    },
                    {
                      "type": "text",
                      "text": name,
                      "size": "sm",
                      "color": "#111111",
                      "align": "end",
                      "wrap": true,
                      "flex": 2
                    }
                  ]
                },
                {
                  "type": "box",
                  "layout": "horizontal",
                  "contents": [
                    {
                      "type": "text",
                      "text": "ãƒ•ãƒªã‚¬ãƒŠ",
                      "size": "sm",
                      "color": "#555555",
                      "flex": 1
                    },
                    {
                      "type": "text",
                      "text": kana,
                      "size": "sm",
                      "color": "#111111",
                      "align": "end",
                      "flex": 2
                    }
                  ],
                  "margin": "sm"
                },
                {
                  "type": "box",
                  "layout": "horizontal",
                  "contents": [
                    {
                      "type": "text",
                      "text": "ãƒ¡ãƒ¼ãƒ«",
                      "size": "sm",
                      "color": "#555555",
                      "flex": 1
                    },
                    {
                      "type": "text",
                      "text": email,
                      "size": "sm",
                      "color": "#111111",
                      "align": "end",
                      "wrap": true,
                      "flex": 2
                    }
                  ],
                  "margin": "sm"
                },
                {
                  "type": "box",
                  "layout": "horizontal",
                  "contents": [
                    {
                      "type": "text",
                      "text": "ãã£ã‹ã‘",
                      "size": "sm",
                      "color": "#555555",
                      "flex": 1
                    },
                    {
                      "type": "text",
                      "text": referral,
                      "size": "sm",
                      "color": "#111111",
                      "align": "end",
                      "wrap": true,
                      "flex": 2
                    }
                  ],
                  "margin": "sm"
                }
              ]
            }
          ]
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "spacing": "sm",
          "contents": [
            {
              "type": "button",
              "style": "primary",
              "action": {
                "type": "message",
                "label": "ä¼šå“¡ç™»éŒ²ã‚’ç¢ºå®šã™ã‚‹",
                "text": "ä¼šå“¡ç™»éŒ²ã‚’ç¢ºå®šã™ã‚‹"
              },
              "color": "#28A745"
            },
            {
              "type": "button",
              "style": "secondary",
              "action": {
                "type": "message",
                "label": "ã‚„ã‚Šç›´ã™",
                "text": "ä¼šå“¡ç™»éŒ²"
              }
            }
          ]
        }
      }
    };
    
    sendLineMessage(replyToken, [confirmationMessage]);
    
  } catch (error) {
    console.error("ä¼šå“¡æƒ…å ±ç¢ºèªç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:", error);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "ä¼šå“¡æƒ…å ±ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * ä¼šå“¡ç™»éŒ²å®Œäº†å‡¦ç†
 */
function finalizeMemberRegistration(replyToken, userId) {
  console.log(`ä¼šå“¡ç™»éŒ²ç¢ºå®š: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ${userId}`);
  
  try {
    // ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¼šå“¡æƒ…å ±ã‚’å–å¾—
    const name = getUserTemp(userId, "member_name");
    const kana = getUserTemp(userId, "member_kana");
    const email = getUserTemp(userId, "member_email");
    const referral = getUserTemp(userId, "member_referral");
    
    if (!name || !kana || !email || !referral) {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ä¼šå“¡æƒ…å ±ãŒä¸å®Œå…¨ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã€Œä¼šå“¡ç™»éŒ²ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚"
      }]);
      return;
    }
    
    // ä¼šå“¡æƒ…å ±ã‚’ä¿å­˜
    const memberInfo = {
      name: name,
      kana: kana,
      email: email,
      referral: referral
    };
    
    const result = saveMemberInfo(userId, memberInfo);
    
    if (result) {
      // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      removeUserTemp(userId);
      
      // ç™»éŒ²å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      sendRegistrationCompletionMessage(replyToken, name);
    } else {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ä¼šå“¡æƒ…å ±ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
      }]);
    }
    
  } catch (error) {
    console.error("ä¼šå“¡ç™»éŒ²ç¢ºå®šã‚¨ãƒ©ãƒ¼:", error);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "ä¼šå“¡æƒ…å ±ã®ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * ä¼šå“¡ç™»éŒ²å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
 */
function sendRegistrationCompletionMessage(replyToken, name) {
  const completionMessage = {
    "type": "flex",
    "altText": "ä¼šå“¡ç™»éŒ²å®Œäº†",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä¼šå“¡ç™»éŒ²å®Œäº†",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#28A745",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": `${name}æ§˜`,
            "weight": "bold",
            "size": "md",
            "align": "center"
          },
          {
            "type": "text",
            "text": "ä¼šå“¡ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
            "align": "center",
            "margin": "md"
          },
          {
            "type": "text",
            "text": "ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å½“åº—ã®äºˆç´„æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ãœã²ã”äºˆç´„ãã ã•ã„ã€‚",
            "size": "sm",
            "color": "#555555",
            "wrap": true,
            "margin": "lg"
          }
        ]
      },
      "footer": {
        "type": "box",
        "layout": "vertical",
        "spacing": "sm",
        "contents": [
          {
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "äºˆç´„ã™ã‚‹",
              "text": "äºˆç´„"
            },
            "color": "#28A745"
          }
        ]
      }
    }
  };
  
  sendLineMessage(replyToken, [completionMessage]);
}

/**
 * ä¼šå“¡æƒ…å ±è¡¨ç¤º
 */
function sendMemberInfoView(replyToken, userId, memberInfo) {
  const memberInfoMessage = {
    "type": "flex",
    "altText": "ä¼šå“¡æƒ…å ±",
    "contents": {
      "type": "bubble",
      "size": "kilo",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ä¼šå“¡æƒ…å ±",
            "weight": "bold",
            "size": "lg",
            "align": "center",
            "color": "#ffffff"
          }
        ],
        "backgroundColor": "#4285F4",
        "paddingTop": "md",
        "paddingBottom": "md"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ç¾åœ¨ã®ç™»éŒ²æƒ…å ±",
            "size": "sm",
            "color": "#888888",
            "align": "center",
            "margin": "md"
          },
          {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "spacing": "sm",
            "contents": [
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "æ°å",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": memberInfo.name,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "wrap": true,
                    "flex": 2
                  }
                ]
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "ãƒ•ãƒªã‚¬ãƒŠ",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": memberInfo.kana,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "flex": 2
                  }
                ],
                "margin": "sm"
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "ãƒ¡ãƒ¼ãƒ«",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": memberInfo.email,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "wrap": true,
                    "flex": 2
                  }
                ],
                "margin": "sm"
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "text",
                    "text": "ãã£ã‹ã‘",
                    "size": "sm",
                    "color": "#555555",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": memberInfo.referral,
                    "size": "sm",
                    "color": "#111111",
                    "align": "end",
                    "wrap": true,
                    "flex": 2
                  }
                ],
                "margin": "sm"
              }
            ]
          }
        ]
      },
      "footer": {
        "type": "box",
        "layout": "vertical",
        "spacing": "sm",
        "contents": [
          /**{
            "type": "button",
            "style": "primary",
            "action": {
              "type": "message",
              "label": "æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹",
              "text": "ä¼šå“¡ç™»éŒ²"
            },
            "color": "#4285F4"
          },*/
          {
            "type": "button",
            "style": "secondary",
            "action": {
              "type": "message",
              "label": "äºˆç´„ã™ã‚‹",
              "text": "äºˆç´„"
            }
          }
        ]
      }
    }
  };
  
  sendLineMessage(replyToken, [memberInfoMessage]);
}

/**
 * ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç”¨ã®FlexMessageã‚’é€ä¿¡
 */
function sendReminderFlexMessage(userId, reservations) {
  try {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
    const userName = getUserDisplayName(userId);
    
    // äºˆç´„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆï¼ˆå„äºˆç´„ã®è¡¨ç¤ºï¼‰
    const reservationItems = reservations.map(event => {
      const startTime = event.getStartTime();
      const endTime = event.getEndTime();
      
      const dateStr = formatDateWithDay(startTime);
      const timeStr = `${startTime.getHours()}:00ï½${endTime.getHours()}:00`;
      
      return {
        "type": "box",
        "layout": "vertical",
        "margin": "lg",
        "contents": [
          {
            "type": "text",
            "text": dateStr,
            "weight": "bold",
            "size": "sm"
          },
          {
            "type": "text",
            "text": timeStr,
            "size": "sm",
            "margin": "sm"
          },
          {
            "type": "separator",
            "margin": "md"
          }
        ]
      };
    });
    
    // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const reminderMessage = {
      "type": "flex",
      "altText": "æ˜æ—¥ã®äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼",
      "contents": {
        "type": "bubble",
        "size": "kilo",
        "header": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "æ˜æ—¥ã®äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼",
              "weight": "bold",
              "size": "lg",
              "align": "center",
              "color": "#ffffff"
            }
          ],
          "backgroundColor": "#4285F4",
          "paddingTop": "md",
          "paddingBottom": "md"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": `${userName}æ§˜ã€æ˜æ—¥ã®äºˆç´„ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™`,
              "size": "md",
              "wrap": true,
              "margin": "md"
            },
            ...reservationItems,
            {
              "type": "text",
              "text": "ã”æ¥åº—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚",
              "size": "sm",
              "color": "#555555",
              "margin": "xxl",
              "wrap": true
            }
          ]
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "spacing": "sm",
          "contents": [
            {
              "type": "button",
              "style": "primary",
              "action": {
                "type": "message",
                "label": "äºˆç´„ç¢ºèª",
                "text": "äºˆç´„ç¢ºèª"
              }
            }
          ]
        }
      }
    };
    
    // ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    sendPushMessage(userId, [reminderMessage]);
    
  } catch (error) {
    console.error("ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼FlexMessageä½œæˆã‚¨ãƒ©ãƒ¼:", error);
    
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒªãƒã‚¤ãƒ³ãƒ‰
    const reservationTexts = reservations.map(event => {
      const startTime = event.getStartTime();
      const endTime = event.getEndTime();
      
      const dateStr = formatDateWithDay(startTime);
      const timeStr = `${startTime.getHours()}:00ï½${endTime.getHours()}:00`;
      
      return `${dateStr} ${timeStr}`;
    }).join("\n");
    
    const userName = getUserDisplayName(userId);
    const textMessage = {
      type: "text",
      text: `${userName}æ§˜ã€æ˜æ—¥ã®äºˆç´„ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ï¼š\n\n${reservationTexts}\n\nã”æ¥åº—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚å¤‰æ›´ã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒå¿…è¦ãªå ´åˆã¯ã€Œäºˆç´„ç¢ºèªã€ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚`
    };
    
    sendPushMessage(userId, [textMessage]);
  }
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«äºˆç´„æƒ…å ±ã‚’è¨˜éŒ²
 */
function recordReservationToSheet(reservation) {
  try {
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
    const sheet = getOrCreateReservationSheet();
    
    // äºˆç´„æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
    sheet.appendRow([
      reservation.eventId,
      reservation.userId,
      reservation.userName,
      reservation.date,
      reservation.time,
      reservation.isoDate,
      reservation.startHour,
      reservation.status,
      Utilities.formatDate(reservation.timestamp, TIME_ZONE, 'yyyy-MM-dd HH:mm:ss')
    ]);
    
    console.log(`äºˆç´„æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²: ${reservation.date} ${reservation.time}`);
    return true;
  } catch (error) {
    console.error("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨˜éŒ²ã‚¨ãƒ©ãƒ¼:", error);
    return false;
  }
}

/**
 * äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
 */
function updateReservationStatus(eventId, status, note) {
  try {
    const sheet = getOrCreateReservationSheet();
    const data = sheet.getDataRange().getValues();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆIDã«ä¸€è‡´ã™ã‚‹è¡Œã‚’æ¤œç´¢
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === eventId) {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆåˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
        sheet.getRange(i + 1, 8).setValue(status);
        
        // å‚™è€ƒæ¬„ã«è¿½è¨˜ï¼ˆåˆ—ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if (sheet.getLastColumn() >= 10) {
          sheet.getRange(i + 1, 10).setValue(note);
        } else {
          // å‚™è€ƒæ¬„ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
          sheet.getRange(i + 1, 10).setValue(note);
        }
        
        console.log(`äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°: ${eventId} -> ${status}`);
        return true;
      }
    }
    
    console.log(`æ›´æ–°å¯¾è±¡ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${eventId}`);
    return false;
  } catch (error) {
    console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
    return false;
  }
}

/**
 * ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼ˆGASã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
 */
function testLineBot() {
  const testEvent = {
    postData: {
      contents: JSON.stringify({
        events: [{
          type: "message",
          replyToken: "test-reply-token",
          message: {
            type: "text",
            text: "ãƒ†ã‚¹ãƒˆ"
          },
          source: {
            userId: "test-user-id"
          }
        }]
      })
    }
  };
  
  doPost(testEvent);
  return "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†";
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œã™ã‚‹é–¢æ•°ï¼‰
 */
function initialSetup() {
  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆæœŸåŒ–
  getOrCreateReservationSheet();
  getOrCreateUserTempSheet();
  getOrCreateMemberSheet();
  
  // ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
  setupTriggers();
  
  // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  testLineBot();
  
  return "ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†";
}

// ======= LINEã¨ã®é€£æº =======
/**
 * Webhookã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹é–¢æ•°
 */
function doPost(e) {
  try {
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    console.log("doPosté–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");
    console.log("å—ä¿¡ãƒ‡ãƒ¼ã‚¿:", e.postData.contents);
    
    const data = JSON.parse(e.postData.contents);
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
    if (!data || !data.events || data.events.length === 0) {
      console.log("æœ‰åŠ¹ãªã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“");
      return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const event = data.events[0];
    
    // ãƒªãƒ—ãƒ©ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯
    if (!event.replyToken || event.replyToken === '00000000000000000000000000000000') {
      console.log("æœ‰åŠ¹ãªãƒªãƒ—ãƒ©ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");
      return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸåˆ†å²å‡¦ç†
    if (event.type === "message" && event.message.type === "text") {
      // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
      const userMessage = event.message.text;
      const userId = event.source.userId;
      const replyToken = event.replyToken;
      
      console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${userMessage}`);
      handleUserMessage(userMessage, userId, replyToken);
    } else if (event.type === "postback") {
      // ãƒã‚¹ãƒˆãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿å‡¦ç†
      const replyToken = event.replyToken;
      const userId = event.source.userId;
      const postbackData = event.postback.data;
      
      console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}, ãƒã‚¹ãƒˆãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿: ${postbackData}`);
      handlePostback(event);
    }
    
  } catch (error) {
    console.error("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:", error, error.stack);
  }
  
  return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†åˆ†å²
 */
function handleUserMessage(userMessage, userId, replyToken) {
  try {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
    if (userMessage === "ãƒ†ã‚¹ãƒˆ") {
      sendLineMessage(replyToken, [{
        type: "text",
        text: "äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚ã€Œäºˆç´„ã€ã¨é€ä¿¡ã—ã¦äºˆç´„ã‚’é–‹å§‹ã™ã‚‹ã‹ã€ã€Œäºˆç´„ç¢ºèªã€ã§ç¾åœ¨ã®äºˆç´„ã‚’ç¢ºèªã§ãã¾ã™ã€‚ã€Œä¼šå“¡ç™»éŒ²ã€ã§ä¼šå“¡æƒ…å ±ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚",
        quickReply: {
          items: [
            {
              type: "action",
              action: {
                type: "message",
                label: "äºˆç´„ã™ã‚‹",
                text: "äºˆç´„"
              }
            },
            {
              type: "action",
              action: {
                type: "message",
                label: "ä¼šå“¡ç™»éŒ²",
                text: "ä¼šå“¡ç™»éŒ²"
              }
            }
          ]
        }
      }]);
      return;
    }
    
    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰
    if (userMessage === "äºˆç´„") {
      // ä¼šå“¡ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      const memberInfo = getMemberInfo(userId);
      if (!memberInfo) {
        // æœªç™»éŒ²ã®å ´åˆã€ä¼šå“¡ç™»éŒ²ã‚’ä¿ƒã™
        sendLineMessage(replyToken, [{
          type: "text",
          text: "äºˆç´„å‰ã«ä¼šå“¡ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€Œä¼šå“¡ç™»éŒ²ã€ã¨é€ä¿¡ã—ã¦ã€ç™»éŒ²ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚",
          quickReply: {
            items: [{
              type: "action",
              action: {
                type: "message",
                label: "ä¼šå“¡ç™»éŒ²",
                text: "ä¼šå“¡ç™»éŒ²"
              }
            }]
          }
        }]);
        return;
      }
      
      handleReservationStart(replyToken, userId);
    } else if (userMessage === "ä¼šå“¡ç™»éŒ²") {
      // ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ é–‹å§‹
      startMemberRegistration(replyToken, userId);
    } else if (userMessage.match(/^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥ï¼ˆ[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]ï¼‰$/)) {
      // æ—¥ä»˜é¸æŠå¾Œ
      handleDateSelection(replyToken, userId, userMessage);
    } else if (userMessage.match(/^(\d{1,2})æ™‚$/)) {
      // æ™‚é–“é¸æŠå¾Œï¼ˆæ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
      const hour = parseInt(userMessage.match(/^(\d{1,2})æ™‚$/)[1]);
      handleHourSelection(replyToken, userId, hour);
    } else if (userMessage === "äºˆç´„ç¢ºèª") {
      // äºˆç´„ç¢ºèª
      handleReservationConfirmation(replyToken, userId);
    } else if (userMessage.startsWith("ã‚­ãƒ£ãƒ³ã‚»ãƒ«:")) {
      // äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªç”»é¢
      const eventId = userMessage.split(":")[1];
      handleCancellationConfirmation(replyToken, userId, eventId);
    } else if (userMessage === "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹") {
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºå®š
      handleCancellationConfirmed(replyToken, userId);
    } else if (userMessage === "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„") {
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ“ä½œã®ä¸­æ­¢
      removeUserTemp(userId);
      sendLineMessage(replyToken, [{
        type: "text",
        text: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ“ä½œã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
      }]);
    } else if (userMessage === "äºˆç´„ã‚’ç¢ºå®šã™ã‚‹") {
      finalizeReservation(replyToken, userId);
    } else if (userMessage === "ä¼šå“¡ç™»éŒ²ã‚’ç¢ºå®šã™ã‚‹") {
      // ä¼šå“¡ç™»éŒ²ç¢ºå®š
      finalizeMemberRegistration(replyToken, userId);
    } else if (userMessage.startsWith("ãã£ã‹ã‘:")) {
      // çŸ¥ã£ãŸãã£ã‹ã‘ã®é¸æŠå‡¦ç†
      const referral = userMessage.replace("ãã£ã‹ã‘:", "");
      saveUserTemp(userId, "member_referral", referral);
      saveUserTemp(userId, "member_step", "confirmation");
      
      // å…¥åŠ›å†…å®¹ã®ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
      sendMemberConfirmationForm(replyToken, userId);
    } else {
      // ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®å„ã‚¹ãƒ†ãƒƒãƒ—å‡¦ç†
      const memberStep = getUserTemp(userId, "member_step");
      
      if (memberStep === "name_input") {
        // å…¥åŠ›ã•ã‚ŒãŸåå‰ã‚’ä¿å­˜
        saveUserTemp(userId, "member_name", userMessage);
        saveUserTemp(userId, "member_step", "kana_input");
        
        // ãƒ•ãƒªã‚¬ãƒŠå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
        sendKanaInputForm(replyToken);
        return;
      } else if (memberStep === "kana_input") {
        // å…¥åŠ›ã•ã‚ŒãŸãƒ•ãƒªã‚¬ãƒŠã‚’ä¿å­˜
        saveUserTemp(userId, "member_kana", userMessage);
        saveUserTemp(userId, "member_step", "email_input");
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
        sendEmailInputForm(replyToken);
        return;
      } else if (memberStep === "email_input") {
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!userMessage.includes('@') || !userMessage.includes('.')) {
          sendLineMessage(replyToken, [{
            type: "text",
            text: "æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
          }]);
          return;
        }
        
        // å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜
        saveUserTemp(userId, "member_email", userMessage);
        saveUserTemp(userId, "member_step", "referral_input");
        
        // çŸ¥ã£ãŸãã£ã‹ã‘é¸æŠç”»é¢ã‚’è¡¨ç¤º
        sendReferralForm(replyToken);
        return;
      }
    }
    
    // ã‚³ãƒãƒ³ãƒ‰ã«è©²å½“ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
  } catch (error) {
    console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error, error.stack);
    sendLineMessage(replyToken, [{
      type: "text",
      text: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
  }
}

/**
 * äºˆç´„é–‹å§‹å‡¦ç†
 */
function handleReservationStart(replyToken, userId) {
  // éå»ã®äºˆç´„ãƒ•ãƒ­ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
  removeUserTemp(userId);
  
  // äºˆç´„ä¸Šé™ãƒã‚§ãƒƒã‚¯
  const userReservations = getUserFutureReservations(userId);
  if (userReservations.length >= MAX_RESERVATIONS_PER_USER) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: `äºˆç´„å¯èƒ½æ ï¼ˆ${MAX_RESERVATIONS_PER_USER}æ ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚æ–°ãŸã«äºˆç´„ã™ã‚‹ã«ã¯ã€æ—¢å­˜ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ãã ã•ã„ã€‚`
    }]);
    return;
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
  let userName = getUserDisplayName(userId);
  
  // äºˆç´„ãƒ•ãƒ­ãƒ¼é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const welcomeMessage = [{
    type: "text",
    text: `${userName}æ§˜ã€ã”äºˆç´„ã‚’æ‰¿ã‚Šã¾ã™ã€‚\nå¸Œæœ›æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`
  }];
  
  // æ—¥ä»˜é¸æŠç”»é¢ã‚’è¡¨ç¤º
  sendDateSelection(replyToken, welcomeMessage);
}

/**
 * LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
 */
function sendLineMessage(replyToken, messages) {
  const url = "https://api.line.me/v2/bot/message/reply";
  const payload = {
    replyToken: replyToken,
    messages: messages
  };
  
  const options = {
    method: "post",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${LINE_ACCESS_TOKEN}`
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  try {
    console.log("LINE APIé€ä¿¡:", JSON.stringify(payload));
    const response = UrlFetchApp.fetch(url, options);
    const status = response.getResponseCode();
    
    if (status != 200) {
      console.error("LINE API ã‚¨ãƒ©ãƒ¼:", response.getContentText());
    }
  } catch (error) {
    console.error("LINE API ä¾‹å¤–:", error);
  }
}

/**
 * LINEã«ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
 */
function sendPushMessage(userId, messages) {
  const url = "https://api.line.me/v2/bot/message/push";
  const payload = {
    to: userId,
    messages: messages
  };
  
  const options = {
    method: "post",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${LINE_ACCESS_TOKEN}`
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  try {
    console.log("ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:", JSON.stringify(payload));
    const response = UrlFetchApp.fetch(url, options);
    const status = response.getResponseCode();
    
    if (status != 200) {
      console.error("ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", response.getContentText());
    }
  } catch (error) {
    console.error("ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¾‹å¤–:", error);
  }
}

/**
 * æ—¥ä»˜é¸æŠç”»é¢ã‚’é€ä¿¡
 */
function sendDateSelection(replyToken, additionalMessages = []) {
  console.log("æ—¥ä»˜é¸æŠç”»é¢ã‚’é€ä¿¡");
  
  const availableDates = getAvailableDates();
  
  // Flex Messageã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã®æ—¥ä»˜é¸æŠã‚’ä½œæˆ
  const calendarMessage = createCalendarFlexMessage(availableDates);
  
  const messages = [...additionalMessages, calendarMessage];
  
  sendLineMessage(replyToken, messages);
}

/**
 * æ—¥ä»˜ã‚’ã€ŒYYYYå¹´MMæœˆDDæ—¥ï¼ˆæ›œæ—¥ï¼‰ã€å½¢å¼ã«å¤‰æ›
 */
function formatDateWithDay(date) {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const dayOfWeek = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][date.getDay()];
  
  return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${dayOfWeek}ï¼‰`;
}

/**
 * ã€ŒYYYYå¹´MMæœˆDDæ—¥ï¼ˆæ›œæ—¥ï¼‰ã€å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
 */
function parseDateString(dateStr) {
  console.log("æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹:", dateStr);
  
  // "2023å¹´10æœˆ25æ—¥ï¼ˆæ°´ï¼‰" â†’ æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if (!match) return null;
  
  const year = parseInt(match[1]);
  const month = parseInt(match[2]) - 1; // æœˆã¯0-11
  const day = parseInt(match[3]);
  
  return new Date(year, month, day);
}

/**
 * äºˆç´„å¯èƒ½ãªæ—¥ä»˜ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
 */
function getAvailableDates() {
  console.log("äºˆç´„å¯èƒ½æ—¥ä»˜ã‚’å–å¾—");
  const today = new Date();
  const dates = [];
  
  // ä»Šæ—¥ã‹ã‚‰MIN_DAYS_AHEADæ—¥å¾Œã‹ã‚‰DAYS_AHEADæ—¥å¾Œã¾ã§ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
  for (let i = MIN_DAYS_AHEAD; i <= DAYS_AHEAD; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    
    // å®šä¼‘æ—¥ã¯ã‚¹ã‚­ãƒƒãƒ—
    if (CLOSED_DAYS.includes(date.getDay())) {
      continue;
    }
    
    // æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ï¼ˆYYYYå¹´MMæœˆDDæ—¥ï¼ˆæ›œæ—¥ï¼‰ï¼‰ã«å¤‰æ›
    const formattedDate = formatDateWithDay(date);
    dates.push(formattedDate);
  }
  
  return dates;
}

/**
 * æ—¥ä»˜é¸æŠå¾Œã®å‡¦ç†
 */
function handleDateSelection(replyToken, userId, selectedDate) {
  console.log(`æ—¥ä»˜é¸æŠå‡¦ç†: ${selectedDate}`);
  
  // æ—¥ä»˜æ–‡å­—åˆ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
  const date = parseDateString(selectedDate);
  if (!date) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: "æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    }]);
    return;
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã«é¸æŠã—ãŸæ—¥ä»˜ã‚’ä¿å­˜
  saveUserTemp(userId, "selectedDate", selectedDate);
  
  // é¸æŠã—ãŸæ—¥ä»˜ã®äºˆç´„å¯èƒ½ãªæ™‚é–“æ ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  sendTimeSelection(replyToken, userId, date);
}

/**
 * é€±ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆï¼ˆ2åˆ—6è¡Œè¡¨ç¤ºï¼‰
 */
function createWeekCalendarContent(weekDates, weekTitle, weekIndex) {
  const dayNames = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
  
// æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
const dateButtons = weekDates.map(d => {
  const day = d.date.getDate();
  const month = d.date.getMonth() + 1;
  const dayOfWeek = d.date.getDay();
  
  // æ›œæ—¥ã”ã¨ã®è‰²ã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
  let textColor, buttonStyle;
  
  if (dayOfWeek === 0) {
    // æ—¥æ›œæ—¥: èƒŒæ™¯ç™½ã€ãƒ©ãƒ™ãƒ«èµ¤
    textColor = "#FF5551";
    buttonStyle = "secondary"; // secondary ã‚¹ã‚¿ã‚¤ãƒ«ã¯é€šå¸¸ç™½èƒŒæ™¯
  } else if (dayOfWeek === 6) {
    // åœŸæ›œæ—¥: èƒŒæ™¯è–„ã„é’ã€ãƒ©ãƒ™ãƒ«é’
    textColor = "#5181FF";
    buttonStyle = "primary"; // primary ã‚¹ã‚¿ã‚¤ãƒ«ã¯é’èƒŒæ™¯
  } else {
    // å¹³æ—¥: èƒŒæ™¯è–„ã„ç°è‰²ã€ãƒ©ãƒ™ãƒ«é»’
    textColor = "#333333";
    buttonStyle = "link"; // link ã‚¹ã‚¿ã‚¤ãƒ«ã¯é€šå¸¸ç°è‰²èƒŒæ™¯
  }
  
  // ãƒœã‚¿ãƒ³ã®ä»£ã‚ã‚Šã«ãƒœãƒƒã‚¯ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½¿ç”¨ã—ã¦æ ç·šã‚’è¿½åŠ 
  return {
    "type": "box",
    "layout": "vertical",
    "borderColor": "#000000",
    "borderWidth": "1px",
    "cornerRadius": "12px",
    "margin": "xs",
    "flex": 1,
    "contents": [
      {
        "type": "button",
        "action": {
          "type": "message",
          "label": `${month}/${day}(${dayNames[dayOfWeek]})`,
          "text": d.dateStr
        },
        "color": textColor,
        "style": buttonStyle,
        "height": "sm",
        "adjustMode": "shrink-to-fit"
      }
    ]
  };
});

  
  // 2åˆ—ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’2ã¤ãšã¤ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const rows = [];
  for (let i = 0; i < dateButtons.length; i += 2) {
    const rowButtons = [dateButtons[i]];
    
    // 2ã¤ç›®ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    if (i + 1 < dateButtons.length) {
      rowButtons.push(dateButtons[i + 1]);
    } else {
      // å¥‡æ•°å€‹ã®å ´åˆã€ç©ºã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦æ•´åˆ—
      rowButtons.push({
        "type": "filler"
      });
    }
    
    rows.push({
      "type": "box",
      "layout": "horizontal",
      "margin": "xs",
      "contents": rowButtons,
      "spacing": "xs"
    });
  }
  
  // è¡¨ç¤ºå¯èƒ½ãªè¡Œæ•°ã‚’6è¡Œã«åˆ¶é™
  const maxRows = 6;
  const displayedRows = rows.slice(0, maxRows);
  
  // é€±è¡¨ç¤ºã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
  return {
    "type": "bubble",
    "size": "mega",
    "header": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": ` ${weekTitle}`,
          "weight": "bold",
          "size": "md",
          "align": "center"
        },
        {
          "type": "text",
          "text": "äºˆç´„å¸Œæœ›æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„",
          "size": "sm",
          "color": "#888888",
          "align": "center",
          "margin": "md"
        }
      ],
      "paddingBottom": "md"
    },
    "body": {
      "type": "box",
      "layout": "vertical",
      "spacing": "sm",
      "contents": displayedRows,
      "paddingAll": "md" // ä½™ç™½ã‚’è¿½åŠ ã—ã¦è¦‹ã‚„ã™ã
    }
  };
}

/**
 * Flex Messageã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã®æ—¥ä»˜é¸æŠUIã‚’ä½œæˆï¼ˆé€±å˜ä½ï¼‰
 */
function createCalendarFlexMessage(availableDates) {
  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
  const today = new Date();
  
  // æ—¥ä»˜ã‚’ã€ŒYYYYå¹´MMæœˆDDæ—¥ï¼ˆæ›œæ—¥ï¼‰ã€å½¢å¼ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
  const dateObjects = availableDates.map(dateStr => {
    return {
      dateStr: dateStr,
      date: parseDateString(dateStr)
    };
  });
  
  // 6æ—¥ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆ1ã‚«ãƒ«ãƒ¼ã‚»ãƒ«å½“ãŸã‚Š6æ—¥è¡¨ç¤ºï¼‰
  const dateGroups = [];
  for (let i = 0; i < dateObjects.length; i += 6) {
    dateGroups.push(dateObjects.slice(i, i + 6));
  }
  
  // å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
  const groupCalendars = dateGroups.map((group, index) => {
    // ã‚°ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥
    const startDate = group[0].date;
    const endDate = group[group.length - 1].date;
    
    // ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼š5æœˆ1æ—¥ï½5æœˆ6æ—¥ï¼‰
    const groupTitle = `${(startDate.getMonth() + 1)}æœˆ${startDate.getDate()}æ—¥ï½${(endDate.getMonth() + 1)}æœˆ${endDate.getDate()}æ—¥`;
    
    return createWeekCalendarContent(group, groupTitle, index);
  });
  
  // Flex Messageã®ã‚«ãƒ«ãƒ¼ã‚»ãƒ«å½¢å¼ã§è¡¨ç¤º
  return {
    "type": "flex",
    "altText": "äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„",
    "contents": {
      "type": "carousel",
      "contents": groupCalendars
    }
  };
}

/**
 * æ—¥ä»˜ã®week numberã‚’å–å¾—ï¼ˆ1å¹´ã®ä¸­ã®ä½•é€±ç›®ã‹ï¼‰
 */
function getWeekNumber(date) {
  const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
  const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
  return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

/**
 * æ™‚é–“é¸æŠç”»é¢ã‚’é€ä¿¡
 */
function sendTimeSelection(replyToken, userId, date) {
  // é¸æŠã—ãŸæ—¥ä»˜ã®äºˆç´„å¯èƒ½ãªæ™‚é–“æ ã‚’å–å¾—
  const availableTimeSlots = getAvailableTimeSlots(date);
  
  if (availableTimeSlots.length === 0) {
    sendLineMessage(replyToken, [{
      type: "text",
      text: `é¸æŠã—ãŸæ—¥ã¯äºˆç´„å¯èƒ½ãªæ™‚é–“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`,
      quickReply: {
        items: [{
          type: "action",
          action: {
            type: "message",
            label: "æ—¥ä»˜ã‚’é¸ã³ç›´ã™",
            text: "äºˆç´„"
          }
        }]
      }
    }]);
    return;
  }
  
  // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®è¡¨ç¤º
  const selectedDate = formatDateWithDay(date);
  
  // Flex Messageã§æ™‚é–“é¸æŠUIã‚’ä½œæˆ
  const timeSelectionMessage = createTimeSelectionFlexMessage(selectedDate, availableTimeSlots);
  
  sendLineMessage(replyToken, [timeSelectionMessage]);
}

/**
 * æ™‚é–“é¸æŠç”¨ã®FlexMessageã‚’ä½œæˆï¼ˆ2åˆ—è¡¨ç¤ºï¼‰
 */
function createTimeSelectionFlexMessage(selectedDate, availableTimeSlots) {
  // æ™‚é–“ãƒœã‚¿ãƒ³ã‚’ä½œæˆï¼ˆæ ç·šä»˜ãã€èƒŒæ™¯ç™½ï¼‰
  const timeButtons = availableTimeSlots.map(slot => {
    return {
      "type": "box",
      "layout": "vertical",
      "borderColor": "#000000",
      "borderWidth": "1px",
      "cornerRadius": "12px",
      "margin": "xs",
      "flex": 1,
      "contents": [
        {
          "type": "button",
          "action": {
            "type": "message",
            "label": `${slot.hour}æ™‚`,
            "text": `${slot.hour}æ™‚`
          },
          "style": "link", // link ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç™½èƒŒæ™¯
          "color": "#000000", // ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ¼ã‚’é»’ã«è¨­å®š
          "height": "sm",
          "adjustMode": "shrink-to-fit"
        }
      ]
    };
  });
  
  // æ™‚é–“ãƒœã‚¿ãƒ³ã‚’2ã¤ãšã¤è¡Œã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const rows = [];
  for (let i = 0; i < timeButtons.length; i += 2) {
    const rowButtons = [timeButtons[i]];
    
    // 2ã¤ç›®ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    if (i + 1 < timeButtons.length) {
      rowButtons.push(timeButtons[i + 1]);
    } else {
      // å¥‡æ•°å€‹ã®å ´åˆã€ç©ºã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦æ•´åˆ—
      rowButtons.push({
        "type": "filler"
      });
    }
    
    rows.push({
      "type": "box",
      "layout": "horizontal",
      "margin": "xs",
      "contents": rowButtons,
      "spacing": "xs"
    });
  }
  
  // æ™‚é–“é¸æŠã®FlexMessageã‚’ä½œæˆ
  return {
  "type": "flex",
  "altText": "äºˆç´„æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„",
  "contents": {
    "type": "bubble",
    "size": "mega",
    "header": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": selectedDate,
          "weight": "bold",
          "size": "md",
          "align": "center",
          "wrap": true
        },
        {
          "type": "text",
          "text": "äºˆç´„å¸Œæœ›æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„",
          "size": "sm",
          "color": "#888888",
          "align": "center",
          "margin": "md"
        }
      ],
      "paddingBottom": "md"
    },
    "body": {
      "type": "box",
      "layout": "vertical",
      "spacing": "sm",
      "contents": rows,
      "paddingAll": "md"
    },
    "footer": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "box",
          "layout": "vertical",
          "borderColor": "#000000",
          "borderWidth": "1px",
          "cornerRadius": "12px",
          "contents": [
            {
              "type": "button",
              "action": {
                "type": "message",
                "label": "æ—¥ä»˜ã‚’é¸ã³ç›´ã™",
                "text": "äºˆç´„"
              },
              "style": "secondary",
              "height": "sm",
              "adjustMode": "shrink-to-fit"
            }
          ]
        }
      ]
    }
  }
};
}
